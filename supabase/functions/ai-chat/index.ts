// @ts-ignore - Supabase Edge Runtime types
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

// ============================================
// Configuration - Using Anthropic Claude and OpenAI GPT (round-robin)
// ============================================
const ANTHROPIC_API_KEY = Deno.env.get("ANTHROPIC_API_KEY") ||
  Deno.env.get("VITE_ANTHROPIC_API_KEY") || "";
const OPENAI_API_KEY = Deno.env.get("OPENAI_API_KEY") ||
  Deno.env.get("VITE_OPENAI_API_KEY") || "";
const ANTHROPIC_MODEL = "claude-sonnet-4-20250514";
const OPENAI_MODEL = "gpt-4o";

// Counter for round-robin selection
let requestCounter = 0;

// Supabase client ููุชุญูู ูู ุงูุชุตูููุงุช
const supabaseUrl = Deno.env.get("SUPABASE_URL") || "";
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") || "";
const _supabase = createClient(supabaseUrl, supabaseServiceKey);

// ุงูุชุตูููุงุช ุงูุดุงููุฉ ูุน ูููุงุชูุง ุงูููุชุงุญูุฉ (70+ ุชุตููู)
const FIXED_CATEGORIES = [
  // ุชูููุฉ
  {
    id: "software-dev",
    label: "ุชุทููุฑ ุจุฑูุฌูุงุช",
    keywords: ["ุจุฑูุฌุฉ", "ุณููุชููุฑ", "ูุธุงู", "ุฃุชูุชุฉ", "ููุฏ", "ุจุฑูุงูุฌ", "ุชุทููุฑ"],
  },
  {
    id: "web-dev",
    label: "ุชุทููุฑ ููุงูุน",
    keywords: [
      "ูููุน",
      "ููุจ",
      "ุตูุญุฉ",
      "ููุตุฉ",
      "HTML",
      "CSS",
      "React",
      "WordPress",
    ],
  },
  {
    id: "mobile-apps",
    label: "ุชุทุจููุงุช ุฌูุงู",
    keywords: ["ุชุทุจูู", "ุฌูุงู", "ููุจุงูู", "ุขูููู", "ุฃูุฏุฑููุฏ", "iOS", "Flutter"],
  },
  {
    id: "it-support",
    label: "ุฏุนู ุชููู",
    keywords: ["ุฏุนู ุชููู", "ูุดููุฉ ุชูููุฉ", "IT", "ุตูุงูุฉ ููุจููุชุฑ", "ูุงุจ ุชูุจ"],
  },
  {
    id: "data-analysis",
    label: "ุชุญููู ุจูุงูุงุช",
    keywords: ["ุชุญููู", "ุจูุงูุงุช", "ุฏุงุชุง", "ุฅุญุตุงุฆูุงุช", "Excel", "ุชูุงุฑูุฑ"],
  },
  {
    id: "ai-services",
    label: "ุฎุฏูุงุช ุฐูุงุก ุงุตุทูุงุนู",
    keywords: ["ุฐูุงุก ุงุตุทูุงุนู", "AI", "ุชุนูู ุขูู", "ChatGPT", "ุจูุช"],
  },

  // ุชุตููู
  {
    id: "graphic-design",
    label: "ุชุตููู ุฌุฑุงููู",
    keywords: ["ุชุตููู", "ุฌุฑุงููู", "ุตูุฑ", "ููุชูุดูุจ", "ุงููุณุชุฑูุชูุฑ", "ุจูุณุชุฑ"],
  },
  {
    id: "ui-ux",
    label: "ุชุตููู ูุงุฌูุงุช",
    keywords: ["UI", "UX", "ูุงุฌูุฉ", "ุชุฌุฑุจุฉ ูุณุชุฎุฏู", "ููุฌูุง", "Figma"],
  },
  {
    id: "logo-branding",
    label: "ุดุนุงุฑุงุช ููููุฉ",
    keywords: ["ุดุนุงุฑ", "ูููู", "ูููุฉ", "ุจุตุฑูุฉ", "ุจุฑุงูุฏ", "ุนูุงูุฉ ุชุฌุงุฑูุฉ"],
  },
  {
    id: "interior-design",
    label: "ุชุตููู ุฏุงุฎูู",
    keywords: ["ุชุตููู ุฏุงุฎูู", "ุฏูููุฑ", "ุฃุซุงุซ", "ุบุฑูุฉ", "ุตุงูุฉ"],
  },
  {
    id: "architectural",
    label: "ุชุตููู ูุนูุงุฑู",
    keywords: ["ูุนูุงุฑู", "ููุฏุณุฉ ูุนูุงุฑูุฉ", "ูุฎุทุท", "ูููุง", "ูุจูู"],
  },

  // ูุญุชูู
  {
    id: "content-writing",
    label: "ูุชุงุจุฉ ูุญุชูู",
    keywords: ["ูุชุงุจุฉ", "ูุญุชูู", "ููุงู", "ูุฏููุฉ", "ูุตูุต"],
  },
  {
    id: "copywriting",
    label: "ูุชุงุจุฉ ุฅุนูุงููุฉ",
    keywords: ["ุฅุนูุงููุฉ", "ุณูููุงู", "ูุต ุฅุนูุงูู", "ููุจู"],
  },
  {
    id: "translation",
    label: "ุชุฑุฌูุฉ",
    keywords: ["ุชุฑุฌูุฉ", "ูุบุฉ", "ุฅูุฌููุฒู", "ุนุฑุจู", "ูุฑูุณู", "ุฃููุงูู"],
  },
  {
    id: "voice-over",
    label: "ุชุนููู ุตูุชู",
    keywords: ["ุตูุชู", "ุชุนููู", "ุฑุงูู", "voice over", "ุฏูุจูุงุฌ"],
  },
  {
    id: "proofreading",
    label: "ุชุฏููู ูุบูู",
    keywords: ["ุชุฏููู", "ุฅููุงุฆู", "ูุญูู", "ุชุตุญูุญ", "ูุฑุงุฌุนุฉ"],
  },

  // ุชุณููู
  {
    id: "digital-marketing",
    label: "ุชุณููู ุฑููู",
    keywords: ["ุชุณููู", "ุฑููู", "ุฅุนูุงู", "ุญููุฉ", "ุชุฑููุฌ"],
  },
  {
    id: "social-media",
    label: "ุณูุดูุงู ููุฏูุง",
    keywords: ["ุณูุดูุงู", "ููุฏูุง", "ุงูุณุชูุฑุงู", "ุชููุชุฑ", "ุณูุงุจ", "ุชูู ุชูู"],
  },
  {
    id: "seo",
    label: "ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ",
    keywords: ["SEO", "ูููู", "ุจุญุซ", "ุธููุฑ", "ุชุฑุชูุจ"],
  },
  {
    id: "advertising",
    label: "ุฅุนูุงูุงุช",
    keywords: ["ุฅุนูุงู", "ูููู", "ูููู ุฃุฏุฒ", "ููุณุจูู ุฃุฏุฒ"],
  },

  // ุฎุฏูุงุช ููููุฉ
  {
    id: "legal-services",
    label: "ุฎุฏูุงุช ูุงููููุฉ",
    keywords: ["ูุงููู", "ูุญุงูู", "ุนูุฏ", "ูุถูุฉ", "ูุญููุฉ", "ุชูุซูู"],
  },
  {
    id: "accounting",
    label: "ูุญุงุณุจุฉ",
    keywords: ["ูุญุงุณุจุฉ", "ุถุฑุงุฆุจ", "ููุฒุงููุฉ", "ูุงููุฉ", "ุชุฏููู"],
  },
  {
    id: "consulting",
    label: "ุงุณุชุดุงุฑุงุช",
    keywords: ["ุงุณุชุดุงุฑุฉ", "ูุตูุญุฉ", "ุฎุจุฑุฉ", "ุฅุฏุงุฑูุฉ"],
  },
  {
    id: "hr-services",
    label: "ููุงุฑุฏ ุจุดุฑูุฉ",
    keywords: ["ุชูุธูู", "ููุงุฑุฏ ุจุดุฑูุฉ", "HR", "ููุธููู", "ุฑูุงุชุจ"],
  },

  // ุชุนููู
  {
    id: "tutoring",
    label: "ุฏุฑูุณ ุฎุตูุตูุฉ",
    keywords: ["ุฏุฑุณ", "ุฎุตูุตู", "ูุนูู", "ูุฏุฑุณ", "ุดุฑุญ", "ุชูููุฉ"],
  },
  {
    id: "online-courses",
    label: "ุฏูุฑุงุช ุฃูููุงูู",
    keywords: ["ุฏูุฑุฉ", "ููุฑุณ", "ุฃูููุงูู", "ุชุนูู"],
  },
  {
    id: "language-learning",
    label: "ุชุนููู ูุบุงุช",
    keywords: ["ุชุนููู ูุบุฉ", "ุฅูุฌููุฒู", "ูุฑูุณู", "ูุบุฉ"],
  },
  {
    id: "skills-training",
    label: "ุชุฏุฑูุจ ููุงุฑุงุช",
    keywords: ["ุชุฏุฑูุจ", "ููุงุฑุฉ", "ูุฑุดุฉ ุนูู", "ุชุทููุฑ ุฐุงุช"],
  },

  // ุตุญุฉ
  {
    id: "medical-consult",
    label: "ุงุณุชุดุงุฑุงุช ุทุจูุฉ",
    keywords: ["ุทุจูุจ", "ุฏูุชูุฑ", "ุงุณุชุดุงุฑุฉ ุทุจูุฉ", "ุตุญุฉ"],
  },
  {
    id: "nutrition",
    label: "ุชุบุฐูุฉ",
    keywords: ["ุชุบุฐูุฉ", "ุฏุงูุช", "ุญููุฉ", "ุฃูู ุตุญู", "ูุธุงู ุบุฐุงุฆู"],
  },
  {
    id: "fitness",
    label: "ููุงูุฉ ุจุฏููุฉ",
    keywords: ["ููุงูุฉ", "ุฑูุงุถุฉ", "ุฌูู", "ูุฏุฑุจ ุดุฎุตู", "ุชูุงุฑูู"],
  },
  {
    id: "mental-health",
    label: "ุตุญุฉ ููุณูุฉ",
    keywords: ["ููุณู", "ุนูุงุฌ ููุณู", "ุงุณุชุดุงุฑุฉ ููุณูุฉ", "ููู"],
  },

  // ุตูุงูุฉ ูููุฒู
  {
    id: "plumbing",
    label: "ุณุจุงูุฉ",
    keywords: ["ุณุจุงูุฉ", "ุณุจุงู", "ููุงู", "ุญูููุฉ", "ูุฌุงุฑู", "ุชุณุฑูุจ"],
  },
  {
    id: "electrical",
    label: "ููุฑุจุงุก",
    keywords: ["ููุฑุจุงุก", "ููุฑุจุงุฆู", "ุฃุณูุงู", "ููุด", "ุฅุถุงุกุฉ"],
  },
  {
    id: "ac-services",
    label: "ุชูููู",
    keywords: ["ุชูููู", "ูููู", "ูุฑููู", "ุชุจุฑูุฏ", "ุณุจููุช"],
  },
  {
    id: "home-repair",
    label: "ุฅุตูุงุญุงุช ููุฒููุฉ",
    keywords: ["ุฅุตูุงุญ", "ุตูุงูุฉ ููุฒู", "ุชุตููุญ"],
  },
  {
    id: "appliance-repair",
    label: "ุตูุงูุฉ ุฃุฌูุฒุฉ",
    keywords: ["ุบุณุงูุฉ", "ุซูุงุฌุฉ", "ูุฑู", "ุฌูุงุฒ", "ุตูุงูุฉ ุฃุฌูุฒุฉ"],
  },
  {
    id: "painting",
    label: "ุฏูุงูุงุช",
    keywords: ["ุฏูุงู", "ุทูุงุก", "ุตุจุบ", "ุญุงุฆุท", "ููู"],
  },
  {
    id: "carpentry",
    label: "ูุฌุงุฑุฉ",
    keywords: ["ูุฌุงุฑ", "ุฎุดุจ", "ุฃุซุงุซ", "ุจุงุจ", "ูุงูุฐุฉ"],
  },

  // ููู
  {
    id: "moving",
    label: "ููู ุนูุด",
    keywords: ["ููู", "ุนูุด", "ุฃุซุงุซ", "ุชุฑุญูู", "ุงูุชูุงู"],
  },
  { id: "shipping", label: "ุดุญู", keywords: ["ุดุญู", "ุจุถุงุนุฉ", "ุทุฑุฏ", "ุชุบููู"] },
  {
    id: "delivery",
    label: "ุชูุตูู",
    keywords: ["ุชูุตูู", "ุฏููููุฑู", "ุทูุจ", "ููุฏูุจ"],
  },

  // ุณูุงุฑุงุช
  {
    id: "car-repair",
    label: "ุตูุงูุฉ ุณูุงุฑุงุช",
    keywords: [
      "ุณูุงุฑุฉ",
      "ูููุงูููู",
      "ูุฑุดุฉ",
      "ุตูุงูุฉ ุณูุงุฑุฉ",
      "ููุชุฑ",
      "ุฌูุจ",
      "ููุฒุณ",
      "ุชูููุชุง",
      "ูููุฏุงู",
      "ููุณุงู",
      "ูุฑุณูุฏุณ",
      "ุจู ุฅู ุฏุจููู",
      "ุฃูุฏู",
      "ููุฑุฏ",
      "ุดููุฑูููู",
      "ุฌูุณ",
      "ุฏูุฏุฌ",
      "ููุง",
      "ูููุฏุง",
      "ูุงุฒุฏุง",
      "ุณูุฒููู",
      "ูุทุน ุบูุงุฑ",
      "ุตุฏุงู",
      "ููููุฉ",
      "ุฌูุฑ",
      "ูุฑุงูู",
      "ุฅุทุงุฑุงุช",
      "ุจุทุงุฑูุฉ",
    ],
  },
  {
    id: "car-wash",
    label: "ุบุณูู ุณูุงุฑุงุช",
    keywords: ["ุบุณูู", "ุชูุธูู ุณูุงุฑุฉ", "ุจูููุด"],
  },
  {
    id: "car-rental",
    label: "ุชุฃุฌูุฑ ุณูุงุฑุงุช",
    keywords: ["ุฅูุฌุงุฑ ุณูุงุฑุฉ", "ุชุฃุฌูุฑ", "ุฑูุช"],
  },
  {
    id: "driver-services",
    label: "ุฎุฏูุงุช ุณุงุฆู",
    keywords: ["ุณุงุฆู", "ุฏุฑุงููุฑ", "ุชูุตูู"],
  },

  // ููุงุณุจุงุช
  {
    id: "event-planning",
    label: "ุชูุธูู ููุงุณุจุงุช",
    keywords: ["ุญููุฉ", "ููุงุณุจุฉ", "ุชูุธูู", "ูุนุงููุฉ", "ุญุฏุซ"],
  },
  {
    id: "catering",
    label: "ุชูููู",
    keywords: ["ุชูููู", "ุถูุงูุฉ", "ุจูููู", "ููุชุฑูุฌ"],
  },
  {
    id: "photography",
    label: "ุชุตููุฑ",
    keywords: ["ุชุตููุฑ", "ูุตูุฑ", "ูุงููุฑุง", "ุตูุฑ"],
  },
  {
    id: "videography",
    label: "ุชุตููุฑ ููุฏูู",
    keywords: ["ููุฏูู", "ูููุชุงุฌ", "ููุฏููุบุฑุงูุฑ"],
  },
  {
    id: "entertainment",
    label: "ุชุฑููู",
    keywords: ["ุชุฑููู", "ููุณููู", "ุฏู ุฌู", "ููุดุท"],
  },
  {
    id: "flowers-decor",
    label: "ุฒููุฑ ูุชุฒููู",
    keywords: ["ุฒููุฑ", "ูุฑุฏ", "ุชุฒููู", "ุฏูููุฑ ุญููุฉ"],
  },

  // ุฌูุงู ูุนูุงูุฉ
  {
    id: "hair-styling",
    label: "ุชุตููู ุดุนุฑ",
    keywords: ["ุดุนุฑ", "ูุต", "ุตุจุบุฉ", "ุชุณุฑูุญุฉ", "ุญูุงู"],
  },
  {
    id: "makeup",
    label: "ูููุงุฌ",
    keywords: ["ูููุงุฌ", "ูููุจ", "ุชุฌููู", "ุนุฑูุณ"],
  },
  {
    id: "spa-massage",
    label: "ุณุจุง ููุณุงุฌ",
    keywords: ["ุณุจุง", "ูุณุงุฌ", "ุงุณุชุฑุฎุงุก", "ุนูุงูุฉ"],
  },
  {
    id: "nails",
    label: "ุฃุธุงูุฑ",
    keywords: ["ุฃุธุงูุฑ", "ูุงููููุฑ", "ุจุฏูููุฑ", "ุทูุงุก"],
  },

  // ุชูุธูู
  {
    id: "home-cleaning",
    label: "ุชูุธูู ููุงุฒู",
    keywords: ["ุชูุธูู ููุฒู", "ุดุบุงูุฉ", "ูุธุงูุฉ ููุฒููุฉ"],
  },
  {
    id: "office-cleaning",
    label: "ุชูุธูู ููุงุชุจ",
    keywords: ["ุชูุธูู ููุชุจ", "ูุธุงูุฉ ููุงุชุจ", "ุดุฑูุฉ"],
  },
  {
    id: "laundry",
    label: "ุบุณูู ููู",
    keywords: ["ุบุณูู", "ูู", "ููุงุจุณ", "ูุบุณูุฉ"],
  },
  {
    id: "pest-control",
    label: "ููุงูุญุฉ ุญุดุฑุงุช",
    keywords: ["ุญุดุฑุงุช", "ุตุฑุงุตูุฑ", "ูุฆุฑุงู", "ููุงูุญุฉ", "ุฑุด"],
  },

  // ุทุนุงู
  {
    id: "cooking",
    label: "ุทุจุฎ ููุฒูู",
    keywords: [
      "ุทุจุฎ",
      "ุฃูู",
      "ูุฌุจุฉ",
      "ุทุจุงุฎ",
      "ูุนุตูุจ",
      "ููุฏู",
      "ูุจุณุฉ",
      "ูุทุจู",
      "ุญููุฐ",
      "ูุธุจู",
      "ุดุงูุฑูุง",
      "ููุงูู",
      "ุณูุจูุณุฉ",
      "ุณูุฏููุด",
      "ุจุฑุฌุฑ",
      "ุจูุชุฒุง",
      "ุจุงุณุชุง",
      "ุฑุฒ",
      "ูุญู",
      "ุฏุฌุงุฌ",
      "ุณูู",
      "ูุญู ุจูุฑู",
      "ูุญู ุฎุฑูู",
      "ูุดุงูู",
      "ูุดูู",
      "ููุจูุงุช",
      "ุณูุทุฉ",
      "ุดูุฑุจุฉ",
      "ุญุณุงุก",
      "ูุฎูู",
      "ููููุจุฉ",
      "ูุฌุจูุณ",
      "ูุดุงููู",
      "ูุดูู ูุดุงูู",
      "ูุดูู ูุญู",
      "ูุดูู ุฏุฌุงุฌ",
      "ูุดูู ุณูู",
      "ุฃุฑุฒ ุจุฎุงุฑู",
      "ุฃุฑุฒ ูุจุงุจ",
      "ุฃุฑุฒ ุฏุฌุงุฌ",
      "ุฃุฑุฒ ูุญู",
      "ุฃุฑุฒ ุณูู",
      "ูุดูู ูููู",
      "ูุดูู ุณุนูุฏู",
      "ูุดูู ุฎููุฌู",
      "ูุดูู ุนุฑุจู",
      "ุทุนุงู ูููู",
      "ุทุนุงู ุณุนูุฏู",
      "ุทุนุงู ุฎููุฌู",
      "ุทุนุงู ุนุฑุจู",
      "ุฃุทุจุงู ุนุฑุจูุฉ",
      "ุฃุทุจุงู ููููุฉ",
      "ุฃุทุจุงู ุฎููุฌูุฉ",
      "ุฃุทุจุงู ุดุนุจูุฉ",
      "ุฃูู ุจูุชู",
      "ุฃูู ููุฒูู",
      "ุฃูู ุทุงุฒุฌ",
      "ุฃูู ุฌุงูุฒ",
      "ุชูุตูู ุทุนุงู",
      "ุทูุจ ุทุนุงู",
      "ูุฌุจุฉ ุฌุงูุฒุฉ",
      "ูุฌุจุฉ ุณุงุฎูุฉ",
      "ูุฌุจุฉ ุจุงุฑุฏุฉ",
    ],
  },
  {
    id: "restaurants",
    label: "ูุทุงุนู",
    keywords: [
      "ูุทุนู",
      "ูุทุงุนู",
      "ูุทุนู ูููู",
      "ูุทุนู ุณุนูุฏู",
      "ูุทุนู ุฎููุฌู",
      "ูุทุนู ุนุฑุจู",
      "ูุทุนู ุขุณููู",
      "ูุทุนู ุฅูุทุงูู",
      "ูุทุนู ุตููู",
      "ูุทุนู ูุงุจุงูู",
      "ูุทุนู ููุฏู",
      "ูุทุนู ุชุฑูู",
      "ูุทุนู ูุจูุงูู",
      "ูุทุนู ุดุงูู",
      "ูุทุนู ูุตุฑู",
      "ูุทุนู ูุบุฑุจู",
      "ูุทุนู ุจุญุฑู",
      "ูุทุนู ูุดุงูู",
      "ูุทุนู ุจูุชุฒุง",
      "ูุทุนู ุจุฑุฌุฑ",
      "ูุทุนู ูุทูุฑ",
      "ูุทุนู ุบุฏุงุก",
      "ูุทุนู ุนุดุงุก",
      "ูุทุนู ุณุฑูุน",
      "ูุทุนู ูุงุฎุฑ",
      "ูุทุนู ุดุนุจู",
      "ูุทุนู ุนุงุฆูู",
      "ูุทุนู ููุนุฒุงุฆู",
      "ูุทุนู ููููุงุฆู",
      "ูุทุนู ููููุงุณุจุงุช",
      "ูุทุนู ููุญููุงุช",
      "ูุทุนู ููุฃุนุฑุงุณ",
      "ูุทุนู ููุนุฒุงุฆู",
      "ูุทุนู ููููุงุฆู",
      "ูุทุนู ููููุงุณุจุงุช",
      "ูุทุนู ููุญููุงุช",
      "ูุทุนู ููุฃุนุฑุงุณ",
      "ูุทุนู ููุนุฒุงุฆู",
      "ูุทุนู ููููุงุฆู",
      "ูุทุนู ููููุงุณุจุงุช",
      "ูุทุนู ููุญููุงุช",
      "ูุทุนู ููุฃุนุฑุงุณ",
      "ูุทุนู ููุนุฒุงุฆู",
      "ูุทุนู ููููุงุฆู",
      "ูุทุนู ููููุงุณุจุงุช",
      "ูุทุนู ููุญููุงุช",
      "ูุทุนู ููุฃุนุฑุงุณ",
    ],
  },
  {
    id: "baking",
    label: "ุญูููุงุช ููุฎุจูุฒุงุช",
    keywords: [
      "ุญูููุงุช",
      "ููู",
      "ูุฎุจูุฒุงุช",
      "ุฎุจุฒ",
      "ุชูุฑุชุฉ",
      "ููุงูุฉ",
      "ุจููุงูุฉ",
      "ููููุงุช",
      "ุฒูุงุจูุง",
      "ุนุตูุฏุฉ",
      "ูููุจูุฉ",
      "ุฃู ุนูู",
      "ูุทุงูู",
      "ูุนููู",
      "ูุนู",
      "ุจุณูููุช",
      "ููููุฒ",
      "ุฏููุงุช",
      "ูุงูู",
      "ุจุงู ููู",
      "ูุฑูุจ",
      "ูุฑูุงุณุงู",
      "ุฎุจุฒ ุนุฑุจู",
      "ุฎุจุฒ ุชููุฑ",
      "ุฎุจุฒ ุตุงุฌ",
      "ุฎุจุฒ ุฃุณูุฑ",
      "ุฎุจุฒ ุฃุจูุถ",
      "ุฎุจุฒ ุจุฑ",
      "ุฎุจุฒ ุชูุณุช",
      "ุฎุจุฒ ูุฑูุณู",
      "ุฎุจุฒ ุฅูุทุงูู",
      "ุฎุจุฒ ูุญูู",
      "ุฎุจุฒ ุทุงุฒุฌ",
      "ูุนุฌูุงุช",
      "ูุทุงุฆุฑ",
      "ุจูุชุฒุง",
      "ุจูุชุฒุง ุนุฑุจูุฉ",
    ],
  },
  {
    id: "catering-food",
    label: "ุชูููู ุทุนุงู",
    keywords: [
      "ุชูููู ุทุนุงู",
      "ููุงุฆู",
      "ุจูููู ุฃูู",
      "ุชูููู ููุงุณุจุงุช",
      "ุชูููู ุญููุงุช",
      "ุชูููู ุฃุนุฑุงุณ",
      "ุชูููู ุนุฒุงุฆู",
      "ุชูููู ููุงุณุจุงุช",
      "ุจูููู",
      "ููุชุฑูุฌ",
      "ุฎุฏูุงุช ุทุนุงู",
      "ุชุฌููุฒ ุทุนุงู",
      "ุชุญุถูุฑ ุทุนุงู",
      "ุทุจุฎ ุฌูุงุนู",
      "ุทุจุฎ ููุงุณุจุงุช",
      "ุทุจุฎ ุญููุงุช",
      "ุทุจุฎ ุฃุนุฑุงุณ",
      "ุทุจุฎ ุนุฒุงุฆู",
      "ุทุจุฎ ููุงุฆู",
      "ุทุจุฎ ุฌูุงุนู",
      "ุทุจุฎ ููููุงุณุจุงุช",
      "ุทุจุฎ ููุญููุงุช",
      "ุทุจุฎ ููุฃุนุฑุงุณ",
      "ุทุจุฎ ููุนุฒุงุฆู",
      "ุทุจุฎ ููููุงุฆู",
      "ุฎุฏูุงุช ุงูุชูููู",
      "ุฎุฏูุงุช ุงูููุชุฑูุฌ",
      "ุฎุฏูุงุช ุงูุจูููู",
    ],
  },

  // ุนูุงุฑุงุช
  {
    id: "real-estate",
    label: "ุนูุงุฑุงุช",
    keywords: ["ุนูุงุฑ", "ุดูุฉ", "ูููุง", "ุฃุฑุถ", "ุจูุช", "ุฅูุฌุงุฑ", "ุจูุน"],
  },
  {
    id: "property-mgmt",
    label: "ุฅุฏุงุฑุฉ ุนูุงุฑุงุช",
    keywords: ["ุฅุฏุงุฑุฉ ุนูุงุฑ", "ุชุญุตูู", "ูุณุชุฃุฌุฑูู"],
  },

  // ุญููุงูุงุช
  {
    id: "pet-care",
    label: "ุฑุนุงูุฉ ุญููุงูุงุช",
    keywords: ["ุญููุงู", "ูุท", "ููุจ", "ุฑุนุงูุฉ", "ููุฏูุฉ"],
  },
  {
    id: "pet-grooming",
    label: "ุชุฌููู ุญููุงูุงุช",
    keywords: ["ุชุฌููู ุญููุงูุงุช", "ูุต ุดุนุฑ", "ุญูุงู"],
  },

  // ุฃูู
  {
    id: "security",
    label: "ุฎุฏูุงุช ุฃูููุฉ",
    keywords: ["ุฃูู", "ุญุฑุงุณุฉ", "ุญุงุฑุณ", "ุฃูุงู"],
  },
  {
    id: "cctv",
    label: "ูุงููุฑุงุช ูุฑุงูุจุฉ",
    keywords: ["ูุงููุฑุง", "ูุฑุงูุจุฉ", "CCTV", "ุชุฑููุจ ูุงููุฑุงุช"],
  },

  // ุฃุฎุฑู
  {
    id: "other",
    label: "ุฃุฎุฑู",
    keywords: ["ุฃุฎุฑู", "ูุชููุน", "ุนุงู", "ุบูุฑ ูุญุฏุฏ"],
  },
];

// ุฏุงูุฉ ููุชุญูู ูู ุชุทุงุจู ุงูุชุตููู ูุน ุงููููุงุช ุงูููุชุงุญูุฉ
function findMatchingCategories(text: string): string[] {
  const lowerText = text.toLowerCase();
  const matches: { id: string; label: string; score: number }[] = [];

  for (const cat of FIXED_CATEGORIES) {
    // ุชุฎุทู "ุฃุฎุฑู" ูู ุงูุงูุชุฑุงุญุงุช
    if (cat.id === "other") continue;

    let score = 0;
    for (const keyword of cat.keywords) {
      if (lowerText.includes(keyword.toLowerCase())) {
        score += 1;
      }
    }
    if (score > 0) {
      matches.push({ id: cat.id, label: cat.label, score });
    }
  }

  // ุชุฑุชูุจ ุญุณุจ ุงูุฃูุซุฑ ุชุทุงุจูุงู
  matches.sort((a, b) => b.score - a.score);

  // ุฅุฑุฌุงุน ุฃูุถู 5 ุชุตูููุงุช (ุจุฏูุงู ูู 3) ูุชุดุฌูุน ุงุฎุชูุงุฑ ุชุตูููุงุช ูุชุนุฏุฏุฉ
  return matches.slice(0, 5).map((m) => m.label);
}

// ุฏุงูุฉ ููุชุญูู ููุง ุฅุฐุง ูุงู ุงูุชุตููู ููุฌูุฏุงู (ูุทุงุจูุฉ ูุฑูุฉ)
function isKnownCategory(label: string): boolean {
  if (!label) return false;
  const lowerLabel = label.toLowerCase().trim();

  // ุฅุฒุงูุฉ ุนูุงูุงุช ุงูุชุฑููู ูุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
  const normalizedLabel = lowerLabel.replace(/[ุ?ุุ,.\s]+/g, " ").trim();

  return FIXED_CATEGORIES.some((cat) => {
    const catLabel = cat.label.toLowerCase().trim();
    const normalizedCatLabel = catLabel.replace(/[ุ?ุุ,.\s]+/g, " ").trim();

    // ูุทุงุจูุฉ ุฏูููุฉ
    if (normalizedLabel === normalizedCatLabel) return true;

    // ูุทุงุจูุฉ ุฌุฒุฆูุฉ (ูุญุชูู ุนูู)
    if (
      normalizedLabel.includes(normalizedCatLabel) ||
      normalizedCatLabel.includes(normalizedLabel)
    ) return true;

    // ูุทุงุจูุฉ ูููุงุช (ุฅุฐุง ุชุทุงุจูุช 70% ูู ุงููููุงุช)
    const labelWords = normalizedLabel.split(/\s+/).filter((w) => w.length > 2);
    const catWords = normalizedCatLabel.split(/\s+/).filter((w) =>
      w.length > 2
    );

    if (labelWords.length > 0 && catWords.length > 0) {
      const matchingWords = labelWords.filter((w) =>
        catWords.some((cw) => cw.includes(w) || w.includes(cw))
      );
      const matchRatio = matchingWords.length /
        Math.max(labelWords.length, catWords.length);
      if (matchRatio >= 0.7) return true;
    }

    return false;
  });
}

// ุฏุงูุฉ ูุฅูุฌุงุฏ ุฃูุถู ุชุตููู ูุทุงุจู (ุญุชู ูู ูู ููู ูุทุงุจูุงู ุชูุงูุงู)
function findBestMatchingCategory(
  label: string,
): { id: string; label: string } | null {
  if (!label) return null;
  const lowerLabel = label.toLowerCase().trim();
  const normalizedLabel = lowerLabel.replace(/[ุ?ุุ,.\s]+/g, " ").trim();

  let bestMatch: { id: string; label: string; score: number } | null = null;

  for (const cat of FIXED_CATEGORIES) {
    const catLabel = cat.label.toLowerCase().trim();
    const normalizedCatLabel = catLabel.replace(/[ุ?ุุ,.\s]+/g, " ").trim();
    let score = 0;

    // ูุทุงุจูุฉ ุฏูููุฉ = 100 ููุทุฉ
    if (normalizedLabel === normalizedCatLabel) {
      return { id: cat.id, label: cat.label };
    }

    // ูุทุงุจูุฉ ุฌุฒุฆูุฉ = 50 ููุทุฉ
    if (
      normalizedLabel.includes(normalizedCatLabel) ||
      normalizedCatLabel.includes(normalizedLabel)
    ) {
      score = 50;
    }

    // ูุทุงุจูุฉ ูููุงุช = 30 ููุทุฉ ููู ูููุฉ ูุชุทุงุจูุฉ
    const labelWords = normalizedLabel.split(/\s+/).filter((w) => w.length > 2);
    const catWords = normalizedCatLabel.split(/\s+/).filter((w) =>
      w.length > 2
    );

    if (labelWords.length > 0 && catWords.length > 0) {
      const matchingWords = labelWords.filter((w) =>
        catWords.some((cw) => cw.includes(w) || w.includes(cw))
      );
      score += matchingWords.length * 30;
    }

    if (score > 0 && (!bestMatch || score > bestMatch.score)) {
      bestMatch = { id: cat.id, label: cat.label, score };
    }
  }

  // ุฅุฑุฌุงุน ุฃูุถู ุชุทุงุจู ุฅุฐุง ูุงู ุงูููุงุท >= 30
  return bestMatch && bestMatch.score >= 30
    ? { id: bestMatch.id, label: bestMatch.label }
    : null;
}

function res(data: unknown, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      "Content-Type": "application/json",
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Headers":
        "authorization, x-client-info, apikey, content-type",
      "Access-Control-Allow-Methods": "POST, OPTIONS",
    },
  });
}

// ============================================
// Unified AI Provider (Anthropic or OpenAI)
// ============================================
interface ChatMessage {
  role: string;
  content: string;
}

async function callAnthropic(
  systemPrompt: string,
  messages: ChatMessage[],
): Promise<string> {
  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": ANTHROPIC_API_KEY,
      "anthropic-version": "2023-06-01",
    },
    body: JSON.stringify({
      model: ANTHROPIC_MODEL,
      max_tokens: 4096,
      system: systemPrompt,
      messages: messages,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    console.error("Anthropic API Error:", error);
    throw new Error(error?.error?.message || "Anthropic API call failed");
  }

  const result = await response.json();
  return result.content?.[0]?.text || "";
}

async function callOpenAI(
  systemPrompt: string,
  messages: ChatMessage[],
): Promise<string> {
  // Convert messages to OpenAI format (include system in messages array)
  const openAIMessages: ChatMessage[] = [
    { role: "system", content: systemPrompt },
    ...messages.map((msg) => ({
      role: msg.role === "assistant" ? "assistant" : "user",
      content: msg.content,
    })),
  ];

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: OPENAI_MODEL,
      messages: openAIMessages,
      max_tokens: 4096,
      temperature: 0.7,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    console.error("OpenAI API Error:", error);
    throw new Error(error?.error?.message || "OpenAI API call failed");
  }

  const result = await response.json();
  return result.choices?.[0]?.message?.content || "";
}

async function callAI(
  systemPrompt: string,
  messages: ChatMessage[],
): Promise<{ text: string; provider: string; model: string }> {
  // Round-robin: alternate between providers
  requestCounter++;
  const hasAnthropic = !!ANTHROPIC_API_KEY;
  const hasOpenAI = !!OPENAI_API_KEY;

  if (!hasAnthropic && !hasOpenAI) {
    throw new Error(
      "No AI provider configured. Please set ANTHROPIC_API_KEY or OPENAI_API_KEY",
    );
  }

  let targetProvider: "anthropic" | "openai";
  if (!hasAnthropic) {
    targetProvider = "openai";
  } else if (!hasOpenAI) {
    targetProvider = "anthropic";
  } else {
    // Both available - use round-robin
    targetProvider = (requestCounter % 2 === 0) ? "openai" : "anthropic";
  }

  // Try the target provider, fallback to the other if it fails
  try {
    if (targetProvider === "anthropic") {
      const text = await callAnthropic(systemPrompt, messages);
      return { text, provider: "anthropic", model: ANTHROPIC_MODEL };
    } else {
      const text = await callOpenAI(systemPrompt, messages);
      return { text, provider: "openai", model: OPENAI_MODEL };
    }
  } catch (error) {
    console.warn(`โ๏ธ ${targetProvider} failed, trying fallback...`, error);

    // Fallback to the other provider
    const fallbackProvider = targetProvider === "anthropic"
      ? "openai"
      : "anthropic";

    if (fallbackProvider === "anthropic" && ANTHROPIC_API_KEY) {
      try {
        const text = await callAnthropic(systemPrompt, messages);
        return { text, provider: "anthropic", model: ANTHROPIC_MODEL };
      } catch (fallbackError: unknown) {
        const errorMessage = fallbackError instanceof Error
          ? fallbackError.message
          : String(fallbackError);
        throw new Error(
          `Both providers failed. Last error: ${errorMessage}`,
        );
      }
    } else if (fallbackProvider === "openai" && OPENAI_API_KEY) {
      try {
        const text = await callOpenAI(systemPrompt, messages);
        return { text, provider: "openai", model: OPENAI_MODEL };
      } catch (fallbackError: unknown) {
        const errorMessage = fallbackError instanceof Error
          ? fallbackError.message
          : String(fallbackError);
        throw new Error(
          `Both providers failed. Last error: ${errorMessage}`,
        );
      }
    }

    throw error;
  }
}

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return res({ ok: true });

  try {
    let body;
    try {
      body = await req.json();
    } catch (_e) {
      return res(
        { error: "Valid JSON body is required" },
        400,
      );
    }

    const { prompt, mode = "chat", history = [], chatHistory = [] } = body;
    if (!prompt) return res({ error: "prompt required" }, 400);

    // ุงุณุชุฎุฏุงู chatHistory ุฅุฐุง ูุงู ูุชููุฑุงูุ ูุฅูุง history (ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู)
    const conversationHistory = chatHistory.length > 0 ? chatHistory : history;

    if (!ANTHROPIC_API_KEY && !OPENAI_API_KEY) {
      console.error("โ No AI provider configured!");
      console.error(
        "Available env vars:",
        Object.keys(Deno.env.toObject()).filter((k) => !k.includes("SECRET")),
      );
      return res({
        error:
          "ูุง ููุฌุฏ ููุชุงุญ API ููุฐูุงุก ุงูุงุตุทูุงุนู ูููุฃ ูู Supabase Edge Functions",
        solution:
          "ูุฑุฌู ุฅุถุงูุฉ ANTHROPIC_API_KEY ุฃู OPENAI_API_KEY ูู: Supabase Dashboard โ Settings โ Edge Functions โ Add new secret",
        command:
          "supabase secrets set ANTHROPIC_API_KEY=sk-ant-xxxxx\nor\nsupabase secrets set OPENAI_API_KEY=sk-xxxxx",
      }, 500);
    }

    let systemInstruction = "";

    if (mode === "draft") {
      systemInstruction = `
ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ูู ููุตุฉ "ุฃุจููู" - ููุตุฉ ุณุนูุฏูุฉ ูุฑุจุท ุทุงูุจู ุงูุฎุฏูุงุช ุจููุฏูููุง.

ูููุชู ุงูุฃุณุงุณูุฉ:
1. **ุฅูุดุงุก ุนููุงู** ูู ุงููุต ุงููุฏุฎู (ูุง ุชูุณุฎ ุงููุต ุญุฑููุงู!)
2. **ุชุตููู ุงูุทูุจ** ุจูุงุกู ุนูู ูููู ุงูุนููู ูููุญุชูู ููุนุฑูุชู ุงูุนุงูุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ุชุนูููุงุช ุฅูุดุงุก ุงูุนููุงู:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ **ูุงุนุฏุฉ ุฐูุจูุฉ**: ุงุณุชุฎุฏู ููุท ูุง ูู ููุฌูุฏ ูู ุงููุต - ูุง ุชูุชุฑุถ ูุนูููุงุช ุบูุฑ ููุฌูุฏุฉ!

๐ ุฃูุซูุฉ:
- ุงููุต: "ุฌูุจ ููุฒุณ 2005" โ ุงูุนููุงู: "ูุทููุจ ุฌูุจ ููุฒุณ 2005"
- ุงููุต: "ุชุตููู ุดุนุงุฑ" โ ุงูุนููุงู: "ูุทููุจ ุชุตููู ุดุนุงุฑ"
- ุงููุต: "ุตูุงูุฉ ูููู" โ ุงูุนููุงู: "ูุทููุจ ุตูุงูุฉ ูููู"

๐ฏ ููุงุนุฏ:
1. ุงุจุฏุฃ ุจู "ูุทููุจ" ุฃู "ุฃุจุบู" ุฃู "ุงุจุญุซ ุนู"
2. ูุง ุชูุณุฎ ุงููุต ุญุฑููุงู - ุญูููู ูุนููุงู ูุฎุชุตุฑ
3. ูุง ุชูุชุฑุถ ูุนูููุงุช ุบูุฑ ููุฌูุฏุฉ (ูุทุน ุบูุงุฑุ ุณุจููุชุ ูุฏููุฉุ ุฅูุฎ)
4. ุงูุนููุงู ูุฎุชุตุฑ: 5-10 ูููุงุช ูุญุฏ ุฃูุตู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ง ุชุนูููุงุช ุงูุชุตููู ุงูุฐูู (ููู ุฌุฏุงู):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

**ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ููููู ุงูุนููู ูููุญุชูู!**

๐ **ููู ุชุตูู:**
1. **ุงููู ุงููุญุชูู ุจุนูู**: ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ุนู ุงูุฃุทุจุงูุ ุงูุฎุฏูุงุชุ ุงูููุชุฌุงุชุ ุฅูุฎ
   - ูุซุงู: "ูุนุตูุจ ูููู" โ ุชุนุฑู ุฃูู ุทุนุงู ูููู โ ุชุตููู "ุทุจุฎ ููุฒูู"
   - ูุซุงู: "ููุฏู" โ ุชุนุฑู ุฃูู ุทุนุงู ุฎููุฌู โ ุชุตููู "ุทุจุฎ ููุฒูู"
   - ูุซุงู: "ูุจุณุฉ" โ ุชุนุฑู ุฃูู ุทุนุงู ุณุนูุฏู โ ุชุตููู "ุทุจุฎ ููุฒูู"
   - ูุซุงู: "ุดุงูุฑูุง" โ ุชุนุฑู ุฃูู ุทุนุงู โ ุชุตููู "ุทุจุฎ ููุฒูู"

2. **ุงุณุชุฎุฏู ุงูุณูุงู**: ูุง ุชุนุชูุฏ ููุท ุนูู ุงููููุงุชุ ุจู ุนูู ุงููุนูู
   - "ุฌูุจ ููุฒุณ" โ ุชุนุฑู ุฃูู ุณูุงุฑุฉ โ ุชุตููู "ุตูุงูุฉ ุณูุงุฑุงุช"
   - "ุชุตููู ุดุนุงุฑ" โ ุชุนุฑู ุฃูู ุชุตููู ุฌุฑุงููู โ ุชุตููู "ุชุตููู ุฌุฑุงููู" + "ุดุนุงุฑุงุช ููููุฉ"
   - "ูููุน ุฅููุชุฑููู" โ ุชุนุฑู ุฃูู ุชุทููุฑ ููุจ โ ุชุตููู "ุชุทููุฑ ููุงูุน"

3. **ููู ุงูุซูุงูุฉ ุงููุญููุฉ**: ุงุณุชุฎุฏู ูุนุฑูุชู ุจุงูุซูุงูุฉ ุงูุนุฑุจูุฉ ูุงูุฎููุฌูุฉ
   - ุงูุฃุทุจุงู ุงูููููุฉ (ูุนุตูุจุ ุญููุฐุ ูุธุจู) โ "ุทุจุฎ ููุฒูู"
   - ุงูุฃุทุจุงู ุงูุณุนูุฏูุฉ (ููุฏูุ ูุจุณุฉุ ูุทุจู) โ "ุทุจุฎ ููุฒูู"
   - ุงูุฃุทุจุงู ุงูุฎููุฌูุฉ (ูุดุงูููุ ูุดูู) โ "ุทุจุฎ ููุฒูู"

4. **ุงูุชุตูููุงุช ุงููุชุนุฏุฏุฉ**: ุงุฎุชุฑ 2-5 ุชุตูููุงุช ุนูุฏูุง ููุงุณุจ ุงูุทูุจ ุฃูุซุฑ ูู ุชุตููู
   - "ุชุตููู ุดุนุงุฑ ูุดุฑูุฉ" โ ["ุชุตููู ุฌุฑุงููู", "ุดุนุงุฑุงุช ููููุฉ"]
   - "ูููุน ุฅููุชุฑููู ูุน ุชุทุจูู" โ ["ุชุทููุฑ ููุงูุน", "ุชุทุจููุงุช ุฌูุงู"]
   - "ุตูุงูุฉ ุฌูุจ ููุฒุณ" โ ["ุตูุงูุฉ ุณูุงุฑุงุช"]

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุชุตูููุงุช ุงููุชุงุญุฉ (ุงุฎุชุฑ ูููุง ุญุตุฑูุงู):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ง ุชูููุฉ: "ุชุทููุฑ ุจุฑูุฌูุงุช" | "ุชุทููุฑ ููุงูุน" | "ุชุทุจููุงุช ุฌูุงู" | "ุฏุนู ุชููู" | "ุชุญููู ุจูุงูุงุช" | "ุฎุฏูุงุช ุฐูุงุก ุงุตุทูุงุนู"
๐จ ุชุตููู: "ุชุตููู ุฌุฑุงููู" | "ุชุตููู ูุงุฌูุงุช" | "ุดุนุงุฑุงุช ููููุฉ" | "ุชุตููู ุฏุงุฎูู" | "ุชุตููู ูุนูุงุฑู"
โ๏ธ ูุญุชูู: "ูุชุงุจุฉ ูุญุชูู" | "ูุชุงุจุฉ ุฅุนูุงููุฉ" | "ุชุฑุฌูุฉ" | "ุชุนููู ุตูุชู" | "ุชุฏููู ูุบูู"
๐ ุชุณููู: "ุชุณููู ุฑููู" | "ุณูุดูุงู ููุฏูุง" | "ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ" | "ุฅุนูุงูุงุช"
๐ผ ุฎุฏูุงุช ููููุฉ: "ุฎุฏูุงุช ูุงููููุฉ" | "ูุญุงุณุจุฉ" | "ุงุณุชุดุงุฑุงุช" | "ููุงุฑุฏ ุจุดุฑูุฉ"
๐ ุชุนููู: "ุฏุฑูุณ ุฎุตูุตูุฉ" | "ุฏูุฑุงุช ุฃูููุงูู" | "ุชุนููู ูุบุงุช" | "ุชุฏุฑูุจ ููุงุฑุงุช"
๐ฅ ุตุญุฉ: "ุงุณุชุดุงุฑุงุช ุทุจูุฉ" | "ุชุบุฐูุฉ" | "ููุงูุฉ ุจุฏููุฉ" | "ุตุญุฉ ููุณูุฉ"
๐ง ุตูุงูุฉ ูููุฒู: "ุณุจุงูุฉ" | "ููุฑุจุงุก" | "ุชูููู" | "ุฅุตูุงุญุงุช ููุฒููุฉ" | "ุตูุงูุฉ ุฃุฌูุฒุฉ" | "ุฏูุงูุงุช" | "ูุฌุงุฑุฉ"
๐ ููู: "ููู ุนูุด" | "ุดุญู" | "ุชูุตูู"
๐ ุณูุงุฑุงุช: "ุตูุงูุฉ ุณูุงุฑุงุช" | "ุบุณูู ุณูุงุฑุงุช" | "ุชุฃุฌูุฑ ุณูุงุฑุงุช" | "ุฎุฏูุงุช ุณุงุฆู"
๐ ููุงุณุจุงุช: "ุชูุธูู ููุงุณุจุงุช" | "ุชูููู" | "ุชุตููุฑ" | "ุชุตููุฑ ููุฏูู" | "ุชุฑููู" | "ุฒููุฑ ูุชุฒููู"
๐ ุฌูุงู ูุนูุงูุฉ: "ุชุตููู ุดุนุฑ" | "ูููุงุฌ" | "ุณุจุง ููุณุงุฌ" | "ุฃุธุงูุฑ"
๐งน ุชูุธูู: "ุชูุธูู ููุงุฒู" | "ุชูุธูู ููุงุชุจ" | "ุบุณูู ููู" | "ููุงูุญุฉ ุญุดุฑุงุช"
๐ฝ๏ธ ุทุนุงู: "ุทุจุฎ ููุฒูู" | "ูุทุงุนู" | "ุญูููุงุช ููุฎุจูุฒุงุช" | "ุชูููู ุทุนุงู"
๐๏ธ ุนูุงุฑุงุช: "ุนูุงุฑุงุช" | "ุฅุฏุงุฑุฉ ุนูุงุฑุงุช"
๐ฑ ุญููุงูุงุช: "ุฑุนุงูุฉ ุญููุงูุงุช" | "ุชุฌููู ุญููุงูุงุช"
๐ก๏ธ ุฃูู: "ุฎุฏูุงุช ุฃูููุฉ" | "ูุงููุฑุงุช ูุฑุงูุจุฉ"
๐ฆ ุฃุฎุฑู: "ุฃุฎุฑู" (ููุท ุฅุฐุง ูู ููุงุณุจ ุฃู ุชุตููู ุฃุนูุงู)

๐จ ููุงุนุฏ ุงูุชุตููู ุงูููุงุฆูุฉ (ููู ุฌุฏุงู - ุงุชุจุนูุง ุจุฏูุฉ):

โ๏ธ **ููููุน ููุนุงู ุจุงุชุงู ุงุณุชุฎุฏุงู "ุฃุฎุฑู" ููุญุฏูุง!** โ๏ธ

1. **ูุฌุจ ุงุฎุชูุงุฑ 1-5 ุชุตูููุงุช ุญููููุฉ ุฃููุงู** - ุญุชู ูู ูู ุชูู ูุชุฃูุฏุงู 100%ุ ุงุฎุชุฑ ุฃูุฑุจ ุงูุชุตูููุงุช ููุทูุจ
2. **ุงุณุชุฎุฏู ูููู ุงูุนููู** - ูุง ุชุนุชูุฏ ุนูู ูุทุงุจูุฉ ูููุงุช ุญุฑููุฉ ููุทุ ุจู ุนูู ููู ุงููุนูู ูุงูุณูุงู
3. **ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ** - ุนู ุงูุฃุทุจุงูุ ุงูุฎุฏูุงุชุ ุงูููุชุฌุงุชุ ุงูุซูุงูุฉ ุงููุญููุฉ ุงูุณุนูุฏูุฉ ูุงูุฎููุฌูุฉ
4. **ุงุฎุชุฑ ููุท ูู ุงููุงุฆูุฉ ุฃุนูุงู** - ูุง ุชุฎุชูู ุชุตูููุงุช ุฌุฏูุฏุฉ ุฃุจุฏุงู
5. **"ุฃุฎุฑู" ุชูุถุงู ููุท ูุชุตููู ุฅุถุงูู** - ุฅุฐุง ุดููุช ูู ุงุฎุชูุงุฑุงุชูุ ุฃุถู "ุฃุฎุฑู" ุจุฌุงูุจ ุงูุชุตูููุงุช ุงูุฃุณุงุณูุฉ (ูุซูุงู: ["ุตูุงูุฉ ุณูุงุฑุงุช", "ุฃุฎุฑู"])
6. **"ุฃุฎุฑู" ูุญุฏูุง = ููููุน!** - ูุง ุชุณุชุฎุฏู ["ุฃุฎุฑู"] ูุญุฏูุง ุฅูุง ุฅุฐุง ูุงู ุงูุทูุจ ุบูุฑ ููููู ุชูุงูุงู ุฃู ุนุดูุงุฆู ุชูุงูุงู
7. **ุงูุชุตูููุงุช ุจุงููุต ุงูุนุฑุจู ุงูุฏููู** - ุงุณุชุฎุฏู ููุณ ุงููุต ููุง ูู ุงููุงุฆูุฉ
8. **ูู ุฌุฑูุฆุงู ูู ุงูุงุฎุชูุงุฑ** - ูู ุงูุฃูุถู ุงุฎุชูุงุฑ ุชุตููู ูุฑูุจ ูู ุงููุนูู ุจุฏูุงู ูู "ุฃุฎุฑู"

ุฃูุซูุฉ ุตุญูุญุฉ:
โ ุฎุทุฃ: ["ุฃุฎุฑู"]
โ ุตุญูุญ: ["ุตูุงูุฉ ุณูุงุฑุงุช"] (ุญุชู ูู ูู ุชุฌุฏ ุงููููุฉ ุจุงูุถุจุท)
โ ุตุญูุญ: ["ุทุจุฎ ููุฒูู", "ุฃุฎุฑู"] (ุฅุฐุง ุดููุช)
โ ุตุญูุญ: ["ุชุทููุฑ ููุงูุน", "ุชุทุจููุงุช ุฌูุงู"] (ุชุตูููุงุช ูุชุนุฏุฏุฉ)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุฃุฌุจ ุจู JSON ููุท ุจูุฐุง ุงูุชูุณูู (ุจุฏูู ุฃู ูุต ุขุฎุฑ):
{
  "title": "ุนููุงู ูุฎุชุตุฑ ูุจุฏุฃ ุจู 'ูุทููุจ' ุฃู 'ุฃุจุบู' - ูุง ุชูุณุฎ ุงููุต ุงููุฏุฎู ุญุฑููุงู!",
  "categories": ["ูุฆุฉ1", "ูุฆุฉ2", "ูุฆุฉ3", ...]
}

ููุงุญุธุงุช ูููุฉ:
- **"title"**: ุนููุงู ูุฎุชุตุฑ (5-10 ูููุงุช) ูุจุฏุฃ ุจูููุฉ ุทูุจูุฉ - ูุง ุชูุณุฎ ุงููุต ุงููุฏุฎู ุญุฑููุงู!
- **"categories"**: ูุงุฆูุฉ ุงูุชุตูููุงุช (2-5 ุชุตูููุงุช ูู ูุนุธู ุงูุญุงูุงุช) ูู ุงููุงุฆูุฉ ุฃุนูุงู
  โ๏ธ **ููู ุฌุฏุงู**: ุงุฎุชุฑ ุชุตูููุงุช ูุชุนุฏุฏุฉ! ูุง ุชูุชูู ุจุชุตููู ูุงุญุฏ ุฅูุง ุฅุฐุง ูุงู ุงูุทูุจ ุจุณูุท ุฌุฏุงู
  ุฃูุซูุฉ:
  - "ุตูุงูุฉ ุฌูุจ ููุฒุณ" โ ["ุตูุงูุฉ ุณูุงุฑุงุช", "ูุทุน ุบูุงุฑ"]
  - "ุชุตููู ุดุนุงุฑ ูุดุฑูุฉ" โ ["ุชุตููู ุฌุฑุงููู", "ุดุนุงุฑุงุช ููููุฉ"]
  - "ูููุน ุฅููุชุฑููู ูุน ุชุทุจูู" โ ["ุชุทููุฑ ููุงูุน", "ุชุทุจููุงุช ุฌูุงู"]
  - "ุชูุธูู ููุชุจ" โ ["ุชูุธูู ููุงุชุจ"] (ุชุตููู ูุงุญุฏ ูุงูู)
- ูุง ุชุณุชุฎุฑุฌ ููุฒุงููุฉุ ูููุนุ ุฃู ูุฏุฉ ุชูููุฐ - ูุฐู ุงูุญููู ุบูุฑ ูุทููุจุฉ
- ูุง ุชุนูุฏ ุตูุงุบุฉ ุงููุตู - ููุท ุงูุนููุงู ูุงูุชุตูููุงุช`;
    } else {
      // Default Chat Mode (original behavior)
      systemInstruction = `ุฃูุช ูุณุงุนุฏ ุฐูู ูููุตุฉ "ุฃุจููู" (ููุตุฉ ุทูุจุงุช ุฎุฏูุงุช).
- ุจููุฌุฉ ุณุนูุฏูุฉ ูุฏูุฏุฉ ููุตูุฑุฉ.
- ูุฏูู ุฌูุน ูุนูููุชูู: (ูุตู ุงูุฎุฏูุฉ) ู (ุงููุฏููุฉ).
- ุจูุฌุฑุฏ ุชููุฑ ุงููุตู ูุงููุฏููุฉุ ุงุฌุนู is_ready_to_send = true.

ุฃุฌุจ ุจู JSON ููุท:
{
  "title": "ุนููุงู ุงูุทูุจ",
  "city": "ุงููุฏููุฉ",
  "description_brief": "ูุตู ูุฎุชุตุฑ",
  "response_to_user": "ุฑุฏู ูููุณุชุฎุฏู",
  "is_ready_to_send": boolean
}`;
    }

    // ุชุญููู chatHistory ุฅูู ุชูุณูู Claude
    interface HistoryMessage {
      role: string;
      text?: string;
      parts?: { text?: string }[];
    }
    const claudeMessages: ChatMessage[] = conversationHistory.map((
      msg: HistoryMessage,
    ) => ({
      role: msg.role === "ai" ? "assistant" : "user",
      content: msg.text || msg.parts?.[0]?.text || "",
    }));

    // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุงูุญุงููุฉ
    claudeMessages.push({
      role: "user",
      content: prompt,
    });

    // ูุนุงูุฌุฉ ุฎุงุตุฉ ููุถุน draft - ุชูุงูุจ ูููุตู ููุนููุงู ูุงูุชุตููู
    let parsed;
    if (mode === "draft") {
      // ุชูุงูุจ ุจูู OpenAI ู Claude: ูุฑุฉ OpenAI ููุนููุงู ู Claude ููุชุตูููุ ูุงูุนูุณ
      requestCounter++;
      const useOpenAIForTitle = requestCounter % 2 === 0;
      const useOpenAIForCategories = !useOpenAIForTitle;

      console.log(`๐ Request #${requestCounter}: Title=${useOpenAIForTitle ? 'OpenAI' : 'Claude'}, Categories=${useOpenAIForCategories ? 'OpenAI' : 'Claude'}`);

      // ุฅูุดุงุก ุงูุนููุงู
      const titleSystemPrompt = `
ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ูู ููุตุฉ "ุฃุจููู" - ููุตุฉ ุณุนูุฏูุฉ ูุฑุจุท ุทุงูุจู ุงูุฎุฏูุงุช ุจููุฏูููุง.

ูููุชู: **ุฅูุดุงุก ุนููุงู ููุท** ูู ุงููุต ุงููุฏุฎู.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ุชุนูููุงุช ุฅูุดุงุก ุงูุนููุงู:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ **ูุงุนุฏุฉ ุฐูุจูุฉ**: ุงุณุชุฎุฏู ููุท ูุง ูู ููุฌูุฏ ูู ุงููุต - ูุง ุชูุชุฑุถ ูุนูููุงุช ุบูุฑ ููุฌูุฏุฉ!

๐ ุฃูุซูุฉ:
- ุงููุต: "ุฌูุจ ููุฒุณ 2005" โ ุงูุนููุงู: "ูุทููุจ ุฌูุจ ููุฒุณ 2005"
- ุงููุต: "ุชุตููู ุดุนุงุฑ" โ ุงูุนููุงู: "ูุทููุจ ุชุตููู ุดุนุงุฑ"
- ุงููุต: "ุตูุงูุฉ ูููู" โ ุงูุนููุงู: "ูุทููุจ ุตูุงูุฉ ูููู"
- ุงููุต: "ูุฏุฑุณ ุฑูุงุถูุงุช" โ ุงูุนููุงู: "ูุทููุจ ูุฏุฑุณ ุฑูุงุถูุงุช ุฎุตูุตู"

๐ฏ ููุงุนุฏ:
1. ุงุจุฏุฃ ุจู "ูุทููุจ" ุฃู "ุฃุจุบู" ุฃู "ุงุจุญุซ ุนู"
2. ูุง ุชูุณุฎ ุงููุต ุญุฑููุงู - ุญูููู ูุนููุงู ูุฎุชุตุฑ ูุงุญุชุฑุงูู
3. ูุง ุชูุชุฑุถ ูุนูููุงุช ุบูุฑ ููุฌูุฏุฉ (ูุทุน ุบูุงุฑุ ุณุจููุชุ ูุฏููุฉุ ุฅูุฎ)
4. ุงูุนููุงู ูุฎุชุตุฑ: 5-10 ูููุงุช ูุญุฏ ุฃูุตู
5. ุงุณุชุฎุฏู ููุฌุฉ ุณุนูุฏูุฉ ุจูุถุงุก ูุฏูุฏุฉ

ุฃุฌุจ ุจู JSON ููุท ุจูุฐุง ุงูุชูุณูู (ุจุฏูู ุฃู ูุต ุขุฎุฑ):
{
  "title": "ุนููุงู ูุฎุชุตุฑ ูุจุฏุฃ ุจู 'ูุทููุจ' ุฃู 'ุฃุจุบู' - ูุง ุชูุณุฎ ุงููุต ุงููุฏุฎู ุญุฑููุงู!"
}`;

      // ุฅูุดุงุก ุงูุชุตูููุงุช
      const categoriesSystemPrompt = `
ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ูู ููุตุฉ "ุฃุจููู" - ููุตุฉ ุณุนูุฏูุฉ ูุฑุจุท ุทุงูุจู ุงูุฎุฏูุงุช ุจููุฏูููุง.

ูููุชู: **ุชุตููู ุงูุทูุจ ููุท** ุจูุงุกู ุนูู ูููู ุงูุนููู ูููุญุชูู ููุนุฑูุชู ุงูุนุงูุฉ.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ง ุชุนูููุงุช ุงูุชุตููู ุงูุฐูู (ููู ุฌุฏุงู):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

**ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ููููู ุงูุนููู ูููุญุชูู!**

๐ **ููู ุชุตูู:**
1. **ุงููู ุงููุญุชูู ุจุนูู**: ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ุนู ุงูุฃุทุจุงูุ ุงูุฎุฏูุงุชุ ุงูููุชุฌุงุชุ ุฅูุฎ
   - ูุซุงู: "ูุนุตูุจ ูููู" โ ุชุนุฑู ุฃูู ุทุนุงู ูููู โ ุชุตููู "ุทุจุฎ ููุฒูู"
   - ูุซุงู: "ููุฏู" โ ุชุนุฑู ุฃูู ุทุนุงู ุฎููุฌู โ ุชุตููู "ุทุจุฎ ููุฒูู"
   - ูุซุงู: "ูุจุณุฉ" โ ุชุนุฑู ุฃูู ุทุนุงู ุณุนูุฏู โ ุชุตููู "ุทุจุฎ ููุฒูู"
   - ูุซุงู: "ุดุงูุฑูุง" โ ุชุนุฑู ุฃูู ุทุนุงู โ ุชุตููู "ุทุจุฎ ููุฒูู"

2. **ุงุณุชุฎุฏู ุงูุณูุงู**: ูุง ุชุนุชูุฏ ููุท ุนูู ุงููููุงุชุ ุจู ุนูู ุงููุนูู
   - "ุฌูุจ ููุฒุณ" โ ุชุนุฑู ุฃูู ุณูุงุฑุฉ โ ุชุตููู "ุตูุงูุฉ ุณูุงุฑุงุช"
   - "ุชุตููู ุดุนุงุฑ" โ ุชุนุฑู ุฃูู ุชุตููู ุฌุฑุงููู โ ุชุตููู "ุชุตููู ุฌุฑุงููู" + "ุดุนุงุฑุงุช ููููุฉ"
   - "ูููุน ุฅููุชุฑููู" โ ุชุนุฑู ุฃูู ุชุทููุฑ ููุจ โ ุชุตููู "ุชุทููุฑ ููุงูุน"

3. **ููู ุงูุซูุงูุฉ ุงููุญููุฉ**: ุงุณุชุฎุฏู ูุนุฑูุชู ุจุงูุซูุงูุฉ ุงูุนุฑุจูุฉ ูุงูุฎููุฌูุฉ
   - ุงูุฃุทุจุงู ุงูููููุฉ (ูุนุตูุจุ ุญููุฐุ ูุธุจู) โ "ุทุจุฎ ููุฒูู"
   - ุงูุฃุทุจุงู ุงูุณุนูุฏูุฉ (ููุฏูุ ูุจุณุฉุ ูุทุจู) โ "ุทุจุฎ ููุฒูู"
   - ุงูุฃุทุจุงู ุงูุฎููุฌูุฉ (ูุดุงูููุ ูุดูู) โ "ุทุจุฎ ููุฒูู"

4. **ุงูุชุตูููุงุช ุงููุชุนุฏุฏุฉ**: ุงุฎุชุฑ 2-5 ุชุตูููุงุช ุนูุฏูุง ููุงุณุจ ุงูุทูุจ ุฃูุซุฑ ูู ุชุตููู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุชุตูููุงุช ุงููุชุงุญุฉ (ุงุฎุชุฑ ูููุง ุญุตุฑูุงู):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ง ุชูููุฉ: "ุชุทููุฑ ุจุฑูุฌูุงุช" | "ุชุทููุฑ ููุงูุน" | "ุชุทุจููุงุช ุฌูุงู" | "ุฏุนู ุชููู" | "ุชุญููู ุจูุงูุงุช" | "ุฎุฏูุงุช ุฐูุงุก ุงุตุทูุงุนู"
๐จ ุชุตููู: "ุชุตููู ุฌุฑุงููู" | "ุชุตููู ูุงุฌูุงุช" | "ุดุนุงุฑุงุช ููููุฉ" | "ุชุตููู ุฏุงุฎูู" | "ุชุตููู ูุนูุงุฑู"
โ๏ธ ูุญุชูู: "ูุชุงุจุฉ ูุญุชูู" | "ูุชุงุจุฉ ุฅุนูุงููุฉ" | "ุชุฑุฌูุฉ" | "ุชุนููู ุตูุชู" | "ุชุฏููู ูุบูู"
๐ ุชุณููู: "ุชุณููู ุฑููู" | "ุณูุดูุงู ููุฏูุง" | "ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ" | "ุฅุนูุงูุงุช"
๐ผ ุฎุฏูุงุช ููููุฉ: "ุฎุฏูุงุช ูุงููููุฉ" | "ูุญุงุณุจุฉ" | "ุงุณุชุดุงุฑุงุช" | "ููุงุฑุฏ ุจุดุฑูุฉ"
๐ ุชุนููู: "ุฏุฑูุณ ุฎุตูุตูุฉ" | "ุฏูุฑุงุช ุฃูููุงูู" | "ุชุนููู ูุบุงุช" | "ุชุฏุฑูุจ ููุงุฑุงุช"
๐ฅ ุตุญุฉ: "ุงุณุชุดุงุฑุงุช ุทุจูุฉ" | "ุชุบุฐูุฉ" | "ููุงูุฉ ุจุฏููุฉ" | "ุตุญุฉ ููุณูุฉ"
๐ง ุตูุงูุฉ ูููุฒู: "ุณุจุงูุฉ" | "ููุฑุจุงุก" | "ุชูููู" | "ุฅุตูุงุญุงุช ููุฒููุฉ" | "ุตูุงูุฉ ุฃุฌูุฒุฉ" | "ุฏูุงูุงุช" | "ูุฌุงุฑุฉ"
๐ ููู: "ููู ุนูุด" | "ุดุญู" | "ุชูุตูู"
๐ ุณูุงุฑุงุช: "ุตูุงูุฉ ุณูุงุฑุงุช" | "ุบุณูู ุณูุงุฑุงุช" | "ุชุฃุฌูุฑ ุณูุงุฑุงุช" | "ุฎุฏูุงุช ุณุงุฆู"
๐ ููุงุณุจุงุช: "ุชูุธูู ููุงุณุจุงุช" | "ุชูููู" | "ุชุตููุฑ" | "ุชุตููุฑ ููุฏูู" | "ุชุฑููู" | "ุฒููุฑ ูุชุฒููู"
๐ ุฌูุงู ูุนูุงูุฉ: "ุชุตููู ุดุนุฑ" | "ูููุงุฌ" | "ุณุจุง ููุณุงุฌ" | "ุฃุธุงูุฑ"
๐งน ุชูุธูู: "ุชูุธูู ููุงุฒู" | "ุชูุธูู ููุงุชุจ" | "ุบุณูู ููู" | "ููุงูุญุฉ ุญุดุฑุงุช"
๐ฝ๏ธ ุทุนุงู: "ุทุจุฎ ููุฒูู" | "ูุทุงุนู" | "ุญูููุงุช ููุฎุจูุฒุงุช" | "ุชูููู ุทุนุงู"
๐๏ธ ุนูุงุฑุงุช: "ุนูุงุฑุงุช" | "ุฅุฏุงุฑุฉ ุนูุงุฑุงุช"
๐ฑ ุญููุงูุงุช: "ุฑุนุงูุฉ ุญููุงูุงุช" | "ุชุฌููู ุญููุงูุงุช"
๐ก๏ธ ุฃูู: "ุฎุฏูุงุช ุฃูููุฉ" | "ูุงููุฑุงุช ูุฑุงูุจุฉ"
๐ฆ ุฃุฎุฑู: "ุฃุฎุฑู" (ููุท ุฅุฐุง ูู ููุงุณุจ ุฃู ุชุตููู ุฃุนูุงู)

๐จ ููุงุนุฏ ุงูุชุตููู:
1. **ูุฌุจ ุงุฎุชูุงุฑ 1-5 ุชุตูููุงุช ุญููููุฉ** - ุญุชู ูู ูู ุชูู ูุชุฃูุฏุงู 100%
2. **ุงุณุชุฎุฏู ูููู ุงูุนููู** - ูุง ุชุนุชูุฏ ุนูู ูุทุงุจูุฉ ูููุงุช ุญุฑููุฉ ููุท
3. **ุงุฎุชุฑ ููุท ูู ุงููุงุฆูุฉ ุฃุนูุงู** - ูุง ุชุฎุชูู ุชุตูููุงุช ุฌุฏูุฏุฉ
4. **"ุฃุฎุฑู" ุชูุถุงู ููุท ูุชุตููู ุฅุถุงูู** - ุฅุฐุง ุดููุชุ ุฃุถู "ุฃุฎุฑู" ุจุฌุงูุจ ุงูุชุตูููุงุช ุงูุฃุณุงุณูุฉ
5. **"ุฃุฎุฑู" ูุญุฏูุง = ููููุน!** - ูุง ุชุณุชุฎุฏู ["ุฃุฎุฑู"] ูุญุฏูุง

ุฃุฌุจ ุจู JSON ููุท ุจูุฐุง ุงูุชูุณูู (ุจุฏูู ุฃู ูุต ุขุฎุฑ):
{
  "categories": ["ูุฆุฉ1", "ูุฆุฉ2", "ูุฆุฉ3", ...]
}`;

      // ุงุณุชุฏุนุงุก ูููุตู ููุนููุงู ูุงูุชุตููู
      let titleResult: { title?: string } = {};
      let categoriesResult: { categories?: string[] } = {};

      try {
        // ุงุณุชุฏุนุงุก ุงูุนููุงู
        if (useOpenAIForTitle && OPENAI_API_KEY) {
          console.log("๐ต Creating title using OpenAI...");
          const titleResponse = await callOpenAI(titleSystemPrompt, claudeMessages);
          const titleJsonMatch = titleResponse.match(/\{[\s\S]*\}/) || titleResponse.match(/```json\s*([\s\S]*?)```/);
          const titleJsonStr = titleJsonMatch ? (titleJsonMatch[1] || titleJsonMatch[0]) : titleResponse;
          titleResult = JSON.parse(titleJsonStr.trim());
          console.log(`โ Title created by OpenAI: ${titleResult.title}`);
        } else if (ANTHROPIC_API_KEY) {
          console.log("๐ฃ Creating title using Claude...");
          const titleResponse = await callAnthropic(titleSystemPrompt, claudeMessages);
          const titleJsonMatch = titleResponse.match(/\{[\s\S]*\}/) || titleResponse.match(/```json\s*([\s\S]*?)```/);
          const titleJsonStr = titleJsonMatch ? (titleJsonMatch[1] || titleJsonMatch[0]) : titleResponse;
          titleResult = JSON.parse(titleJsonStr.trim());
          console.log(`โ Title created by Claude: ${titleResult.title}`);
        }
      } catch (titleError) {
        console.warn("โ๏ธ Title generation failed, trying fallback...", titleError);
        // Fallback: ุฅุฐุง ูุดู OpenAIุ ุฌุฑุจ Claude ูุงูุนูุณ
        try {
          if (useOpenAIForTitle && ANTHROPIC_API_KEY) {
            console.log("๐ Falling back to Claude for title...");
            const titleResponse = await callAnthropic(titleSystemPrompt, claudeMessages);
            const titleJsonMatch = titleResponse.match(/\{[\s\S]*\}/) || titleResponse.match(/```json\s*([\s\S]*?)```/);
            const titleJsonStr = titleJsonMatch ? (titleJsonMatch[1] || titleJsonMatch[0]) : titleResponse;
            titleResult = JSON.parse(titleJsonStr.trim());
            console.log(`โ Title created by Claude (fallback): ${titleResult.title}`);
          } else if (!useOpenAIForTitle && OPENAI_API_KEY) {
            console.log("๐ Falling back to OpenAI for title...");
            const titleResponse = await callOpenAI(titleSystemPrompt, claudeMessages);
            const titleJsonMatch = titleResponse.match(/\{[\s\S]*\}/) || titleResponse.match(/```json\s*([\s\S]*?)```/);
            const titleJsonStr = titleJsonMatch ? (titleJsonMatch[1] || titleJsonMatch[0]) : titleResponse;
            titleResult = JSON.parse(titleJsonStr.trim());
            console.log(`โ Title created by OpenAI (fallback): ${titleResult.title}`);
          }
        } catch (fallbackError) {
          console.error("โ Title generation completely failed:", fallbackError);
        }
      }

      try {
        // ุงุณุชุฏุนุงุก ุงูุชุตูููุงุช
        if (useOpenAIForCategories && OPENAI_API_KEY) {
          console.log("๐ต Creating categories using OpenAI...");
          const categoriesResponse = await callOpenAI(categoriesSystemPrompt, claudeMessages);
          const categoriesJsonMatch = categoriesResponse.match(/\{[\s\S]*\}/) || categoriesResponse.match(/```json\s*([\s\S]*?)```/);
          const categoriesJsonStr = categoriesJsonMatch ? (categoriesJsonMatch[1] || categoriesJsonMatch[0]) : categoriesResponse;
          categoriesResult = JSON.parse(categoriesJsonStr.trim());
          console.log(`โ Categories created by OpenAI: ${categoriesResult.categories?.join(", ")}`);
        } else if (ANTHROPIC_API_KEY) {
          console.log("๐ฃ Creating categories using Claude...");
          const categoriesResponse = await callAnthropic(categoriesSystemPrompt, claudeMessages);
          const categoriesJsonMatch = categoriesResponse.match(/\{[\s\S]*\}/) || categoriesResponse.match(/```json\s*([\s\S]*?)```/);
          const categoriesJsonStr = categoriesJsonMatch ? (categoriesJsonMatch[1] || categoriesJsonMatch[0]) : categoriesResponse;
          categoriesResult = JSON.parse(categoriesJsonStr.trim());
          console.log(`โ Categories created by Claude: ${categoriesResult.categories?.join(", ")}`);
        }
      } catch (categoriesError) {
        console.warn("โ๏ธ Categories generation failed, trying fallback...", categoriesError);
        // Fallback: ุฅุฐุง ูุดู OpenAIุ ุฌุฑุจ Claude ูุงูุนูุณ
        try {
          if (useOpenAIForCategories && ANTHROPIC_API_KEY) {
            console.log("๐ Falling back to Claude for categories...");
            const categoriesResponse = await callAnthropic(categoriesSystemPrompt, claudeMessages);
            const categoriesJsonMatch = categoriesResponse.match(/\{[\s\S]*\}/) || categoriesResponse.match(/```json\s*([\s\S]*?)```/);
            const categoriesJsonStr = categoriesJsonMatch ? (categoriesJsonMatch[1] || categoriesJsonMatch[0]) : categoriesResponse;
            categoriesResult = JSON.parse(categoriesJsonStr.trim());
            console.log(`โ Categories created by Claude (fallback): ${categoriesResult.categories?.join(", ")}`);
          } else if (!useOpenAIForCategories && OPENAI_API_KEY) {
            console.log("๐ Falling back to OpenAI for categories...");
            const categoriesResponse = await callOpenAI(categoriesSystemPrompt, claudeMessages);
            const categoriesJsonMatch = categoriesResponse.match(/\{[\s\S]*\}/) || categoriesResponse.match(/```json\s*([\s\S]*?)```/);
            const categoriesJsonStr = categoriesJsonMatch ? (categoriesJsonMatch[1] || categoriesJsonMatch[0]) : categoriesResponse;
            categoriesResult = JSON.parse(categoriesJsonStr.trim());
            console.log(`โ Categories created by OpenAI (fallback): ${categoriesResult.categories?.join(", ")}`);
          }
        } catch (fallbackError) {
          console.error("โ Categories generation completely failed:", fallbackError);
        }
      }

      // ุฏูุฌ ุงููุชุงุฆุฌ - ูุน fallback ูููุตูุต ุงููุงุฑุบุฉ
      let finalTitle = titleResult.title || "";
      let finalCategories = categoriesResult.categories || [];

      // ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุนููุงูุ ุฌุฑุจ ุงุณุชุฎุฏุงู ุงูุชุตูููุงุช ูู fallback ุฃู ุงูุนูุณ
      if (!finalTitle && finalCategories.length > 0) {
        console.warn("โ๏ธ Title generation failed but categories succeeded, trying to extract title from prompt...");
        // ูููู ุฅุถุงูุฉ ููุทู ูุงุณุชุฎุฑุงุฌ ุงูุนููุงู ูู ุงููุต ูุจุงุดุฑุฉ
      }

      if (!finalCategories.length && finalTitle) {
        console.warn("โ๏ธ Categories generation failed but title succeeded, trying to extract categories from prompt...");
        // ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ุงูุชุตูููุงุช ูู ุงููุต ูุจุงุดุฑุฉ
        try {
          const extractedCategories = findMatchingCategories(prompt);
          if (extractedCategories.length > 0) {
            finalCategories = extractedCategories.slice(0, 5);
            console.log(`โ Extracted ${finalCategories.length} categories from prompt: ${finalCategories.join(", ")}`);
          }
        } catch (extractError) {
          console.warn("โ๏ธ Failed to extract categories from prompt:", extractError);
        }
      }

      // ุฅุฐุง ูุดู ููุงููุงุ ุงุณุชุฎุฏู ุงุณุชุฏุนุงุก ูุงุญุฏ ูู fallback ููุงุฆู
      if (!finalTitle && !finalCategories.length) {
        console.warn("โ๏ธ Both title and categories generation failed, using unified fallback...");
        try {
          const { text: rawOutput, provider, model } = await callAI(
            systemInstruction,
            claudeMessages,
          );
          console.log(`โ Fallback: ${provider} (${model}) response received`);
          const jsonMatch = rawOutput.match(/\{[\s\S]*\}/) || rawOutput.match(/```json\s*([\s\S]*?)```/);
          const jsonStr = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : rawOutput;
          const fallbackResult = JSON.parse(jsonStr.trim());
          finalTitle = fallbackResult.title || finalTitle;
          finalCategories = fallbackResult.categories || finalCategories;
          
          // ุฅุฐุง ูู ููู ููุงู ุชุตูููุงุช ุจุนุฏ fallbackุ ุงุณุชุฎุฏู ุงุณุชุฎุฑุงุฌ ูู ุงููุต
          if (!finalCategories.length) {
            const extractedCategories = findMatchingCategories(prompt);
            if (extractedCategories.length > 0) {
              finalCategories = extractedCategories.slice(0, 5);
            }
          }
        } catch (fallbackError) {
          console.error("โ Fallback also failed:", fallbackError);
          // ุขุฎุฑ ูุญุงููุฉ: ุงุณุชุฎุฑุงุฌ ุงูุชุตูููุงุช ูู ุงููุต ูุจุงุดุฑุฉ
          const extractedCategories = findMatchingCategories(prompt);
          if (extractedCategories.length > 0) {
            finalCategories = extractedCategories.slice(0, 5);
          }
        }
      }

      parsed = {
        title: finalTitle,
        categories: finalCategories,
        aiResponse: finalTitle && finalCategories.length > 0
          ? `ุชู ุฅูุดุงุก ุงูุนููุงู ูุงูุชุตููู ุจุงุณุชุฎุฏุงู ${useOpenAIForTitle ? 'OpenAI ููุนููุงู' : 'Claude ููุนููุงู'} ู ${useOpenAIForCategories ? 'OpenAI ููุชุตููู' : 'Claude ููุชุตููู'}`
          : "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุนููุงู ุฃู ุงูุชุตููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.",
        isClarification: !finalTitle || !finalCategories.length,
      };
    } else {
      // ูุถุน chat - ุงุณุชุฎุฏุงู ุงูููุฏ ุงูุฃุตูู
      const { text: rawOutput, provider, model } = await callAI(
        systemInstruction,
        claudeMessages,
      );
      console.log(`โ ${provider} (${model}) response received`);

      // ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ JSON
      try {
        // Try to extract JSON from response
        const jsonMatch = rawOutput.match(/\{[\s\S]*\}/) ||
          rawOutput.match(/```json\s*([\s\S]*?)```/);
        const jsonStr = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : rawOutput;
        parsed = JSON.parse(jsonStr.trim());
      } catch (_e) {
        console.warn("Failed to parse JSON, using raw output");
        parsed = {
          aiResponse: rawOutput,
          isClarification: true,
        };
      }
    }

    // ูุนุงูุฌุฉ ุงูุชุตูููุงุช ูู ูุถุน draft
    if (mode === "draft") {
      const validCategories: string[] = [];
      let hasOtherCategory = false;

      // ุฏุงูุฉ ูุชูุธูู ุงูุชุตููู ูู ุนูุงูุงุช ุงูุงุณุชููุงู ูุงููุตูุต ุงูุบุฑูุจุฉ
      const cleanCategory = (cat: string): string => {
        if (!cat) return cat;
        let cleaned = cat.replace(/[ุ?ุ]/g, "").trim();
        cleaned = cleaned.split(/[ุ?ุ]/)[0].trim();
        cleaned = cleaned.replace(/\s+/g, " ").trim();
        return cleaned;
      };

      // ูุนุงูุฌุฉ ุงูุชุตูููุงุช ูู ุงูู AI
      if (parsed.categories && Array.isArray(parsed.categories)) {
        for (const cat of parsed.categories) {
          const cleanedCat = cleanCategory(cat);
          if (!cleanedCat) continue;

          // ุชุณุฌูู ุฅุฐุง ูุงู ุงูุชุตููู "ุฃุฎุฑู" (ุณูุถููู ูุงุญูุงู ุฅุฐุง ูุฒู)
          if (
            cleanedCat.toLowerCase() === "ุฃุฎุฑู" ||
            cleanedCat.toLowerCase() === "other"
          ) {
            hasOtherCategory = true;
            continue;
          }

          // ูุญุงููุฉ ุฅูุฌุงุฏ ุฃูุถู ุชุทุงุจู
          const bestMatch = findBestMatchingCategory(cleanedCat);

          if (bestMatch) {
            // ุฅุถุงูุฉ ุงูุชุตููู ุงููุทุงุจู
            if (!validCategories.includes(bestMatch.label)) {
              validCategories.push(bestMatch.label);
            }
          } else if (isKnownCategory(cleanedCat)) {
            // ุฅุฐุง ูู ูุฌุฏ ุชุทุงุจูุงู ุฌูุฏุงูุ ูุชุญูู ูู ุงูุชุตูููุงุช ุงููุนุฑููุฉ
            const matchedCat = FIXED_CATEGORIES.find((fc) =>
              fc.label.toLowerCase() === cleanedCat.toLowerCase() ||
              fc.label.toLowerCase().includes(cleanedCat.toLowerCase()) ||
              cleanedCat.toLowerCase().includes(fc.label.toLowerCase())
            );
            if (matchedCat && !validCategories.includes(matchedCat.label)) {
              validCategories.push(matchedCat.label);
            }
          }
          // ุฅุฐุง ูู ูุฌุฏ ุชุทุงุจูุงูุ ูุชุฌุงูู ุงูุชุตููู (ูู ูุถูู ุชุตูููุงุช ุบูุฑ ูุนุฑููุฉ)
        }
      }

      // ุฅุฐุง ูู ููู ููุงู ุชุตูููุงุช ุตุญูุญุฉุ ูุญุงูู ุงุณุชุฎุฑุงุฌ ุชุตูููุงุช ูู ุงููุต ูุจุงุดุฑุฉ
      if (validCategories.length === 0) {
        console.log(
          "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุตูููุงุช ูู ุงูู AIุ ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ูู ุงููุต...",
        );

        // ุงุณุชุฎุฏุงู ุฏุงูุฉ findMatchingCategories ููุจุญุซ ูู ุงููุต ุงูุฃุตูู
        const extractedCategories = findMatchingCategories(prompt);

        if (extractedCategories.length > 0) {
          console.log(
            `โ ุชู ุงุณุชุฎุฑุงุฌ ${extractedCategories.length} ุชุตููู(ุงุช) ูู ุงููุต: ${
              extractedCategories.join(", ")
            }`,
          );
          validCategories.push(...extractedCategories.slice(0, 5)); // ุฃูุตู 5 ุชุตูููุงุช
        }
      }

      // ุฅุฐุง ูุง ุฒููุง ุจุฏูู ุชุตูููุงุชุ ูุถูู "ุฃุฎุฑู" ูุญู ุฃุฎูุฑ
      if (validCategories.length === 0) {
        console.log("โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ุชุตูููุงุชุ ุฅุถุงูุฉ 'ุฃุฎุฑู' ูุญู ุฃุฎูุฑ");
        validCategories.push("ุฃุฎุฑู");
      } else {
        // ุฅุถุงูุฉ "ุฃุฎุฑู" ูุชุตููู ุฅุถุงูู ููุท ุฅุฐุง ุฃุฑุณููุง ุงูู AI ููุงู ููุงู ุชุตูููุงุช ุฃุฎุฑู
        if (hasOtherCategory && validCategories.length < 5) {
          validCategories.push("ุฃุฎุฑู");
          console.log(
            `โ ุชู ุงูุนุซูุฑ ุนูู ${validCategories.length} ุชุตููู(ุงุช) ูุน ุฅุถุงูุฉ 'ุฃุฎุฑู' ูุงุญุชูุงุท: ${
              validCategories.join(", ")
            }`,
          );
        } else {
          console.log(
            `โ ุชู ุงูุนุซูุฑ ุนูู ${validCategories.length} ุชุตููู(ุงุช): ${
              validCategories.join(", ")
            }`,
          );
        }
      }

      parsed.categories = [...new Set(validCategories)]; // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ

      // ุฅุฒุงูุฉ ุงูุญููู ุบูุฑ ุงููุทููุจุฉ
      delete parsed.uncertainCategories;
      delete parsed.suggestedCategory;
      delete parsed.description;
      delete parsed.budgetMin;
      delete parsed.budgetMax;
      delete parsed.deliveryTime;
      delete parsed.location;
    }

    return res({
      ...parsed,
      timestamp: new Date().toISOString(),
    });
  } catch (e) {
    console.error("Error in ai-chat:", e);
    return res({ error: String(e) }, 500);
  }
});
