# نظام التقييمات والمراجعات

## نظرة عامة

نظام شامل للتقييمات والمراجعات يسمح لأصحاب الطلبات ومقدمي الخدمات بتقييم بعضهم البعض بعد إتمام العمل بنجاح. يهدف النظام إلى بناء الثقة بين المستخدمين ومساعدة أصحاب الطلبات في اختيار مقدمي خدمات موثوقين.

### المميزات الرئيسية
- **تقييمات بنظام 5 نجوم** مع إمكانية إضافة تعليقات نصية مفصلة
- **عرض المراجعات** في الملف الشخصي لكل مستخدم
- **إحصائيات شاملة** تشمل متوسط التقييم وعدد المراجعات وتوزيعها
- **تصفية ذكية** لمقدمي الخدمات حسب تقييماتهم في صفحة "اكتشف"
- **حماية متقدمة** من التقييمات المزيفة (التقييم مسموح فقط بعد إتمام العمل)

### الأولوية والجداول الزمنية
- **الأولوية:** عالية (المرحلة 2 - قيد التنفيذ)
- **الوقت المتوقع:** 3-4 أسابيع
- **التبعيات:** نظام إتمام الطلبات، الملفات الشخصية للمستخدمين

---

## User Stories

### قصة المستخدم 1: تقييم مقدم الخدمة بعد إتمام العمل
**بصفتي** صاحب طلب  
**أريد** تقييم مقدم الخدمة بعد إتمام العمل بنجاح  
**لكي** أتمكن من مشاركة تجربتي الإيجابية أو السلبية ومساعدة مستخدمين آخرين في اختيار مقدمي خدمات موثوقين

**معايير القبول:**
- يمكنني تقييم مقدم الخدمة فقط بعد أن يكون الطلب في حالة "مكتمل" (completed)
- يمكنني اختيار تقييم من 1 إلى 5 نجوم (1 = سيء جداً، 5 = ممتاز)
- يمكنني كتابة تعليق نصي يشرح تجربتي (اختياري لكن موصى به لمساعدة الآخرين)
- يمكنني تعديل تقييمي خلال 24 ساعة من إنشائه في حالة اكتشفت خطأ أو أردت تحسين التعليق
- لا يمكنني تقييم نفس مقدم الخدمة مرتين لنفس الطلب (منع التكرار)
- أتلقى تأكيداً عند حفظ التقييم بنجاح

### قصة المستخدم 2: تقييم صاحب الطلب بعد إتمام العمل
**بصفتي** مقدم خدمة  
**أريد** تقييم صاحب الطلب بعد إتمام العمل بنجاح  
**لكي** أتمكن من مشاركة تجربتي في التعامل معه ومساعدة مقدمي خدمات آخرين في التعرف على العملاء المحترمين والجديين

**معايير القبول:**
- يمكنني تقييم صاحب الطلب فقط بعد أن يكون الطلب في حالة "مكتمل" (completed)
- يمكنني اختيار تقييم من 1 إلى 5 نجوم
- يمكنني كتابة تعليق نصي يصف تجربتي في التعامل معه (اختياري)
- يمكنني تعديل تقييمي خلال 24 ساعة من إنشائه
- لا يمكنني تقييم نفس صاحب الطلب مرتين لنفس الطلب
- أتلقى تأكيداً عند حفظ التقييم بنجاح

### قصة المستخدم 3: عرض المراجعات في الملف الشخصي
**بصفتي** مستخدم  
**أريد** رؤية جميع المراجعات التي تلقيتها من المستخدمين الآخرين في ملفي الشخصي  
**لكي** أتمكن من فهم سمعتي في المنصة ومراجعة ما قاله الآخرون عن جودة عملي أو تعاملي

**معايير القبول:**
- أرى جميع المراجعات التي تلقيتها مرتبة حسب التاريخ (الأحدث أولاً)
- أرى متوسط تقييمي الإجمالي وعدد المراجعات الكلي بشكل واضح
- يمكنني تصفية المراجعات حسب مستوى التقييم (5 نجوم فقط، 4+ نجوم، إلخ)
- يمكنني النقر على أي مراجعة لرؤية تفاصيل الطلب المرتبط بها
- المراجعات تظهر مع اسم كاتب المراجعة وصورته الشخصية (أو "مستخدم" إذا كان مجهول الهوية)
- يمكنني رؤية تاريخ كل مراجعة بشكل واضح

### قصة المستخدم 4: عرض إحصائيات التقييمات
**بصفتي** مستخدم  
**أريد** رؤية إحصائيات شاملة لتقييماتي (متوسط التقييم، العدد الإجمالي، التوزيع)  
**لكي** أتمكن من فهم أدائي العام وسمعتي في المنصة وتحديد نقاط القوة والضعف

**معايير القبول:**
- أرى متوسط تقييمي بوضوح (مثال: 4.5 من 5 نجوم) مع عدد المراجعات
- أرى عدد المراجعات الإجمالي التي تلقيتها
- أرى توزيع التقييمات بشكل مرئي (كم مراجعة 5 نجوم، 4 نجوم، 3 نجوم، 2 نجوم، 1 نجم)
- الإحصائيات تظهر بشكل بارز في الملف الشخصي
- الإحصائيات تظهر أيضاً في بطاقات المستخدمين عند عرضهم في قوائم أو نتائج بحث
- التوزيع يظهر بشكل رسم بياني أو قائمة واضحة

### قصة المستخدم 5: تصفية مقدمي الخدمات حسب التقييمات
**بصفتي** صاحب طلب  
**أريد** تصفية وترتيب مقدمي الخدمات حسب متوسط تقييماتهم  
**لكي** أتمكن من اختيار مقدمي خدمات موثوقين وذوي سمعة جيدة بسهولة

**معايير القبول:**
- يمكنني تصفية مقدمي الخدمات حسب متوسط التقييم (مثال: عرض فقط من لديهم 4+ نجوم)
- يمكنني ترتيب مقدمي الخدمات حسب التقييم (الأعلى تقييماً أولاً أو الأقل تقييماً أولاً)
- التصفية والترتيب يعملان في صفحة "اكتشف" (Marketplace)
- التصفية والترتيب يعملان أيضاً في نتائج البحث عن مقدمي الخدمات
- يمكنني الجمع بين تصفية التقييمات وفلاتر أخرى (المدينة، التصنيف، إلخ)

---

## Requirements

### Functional Requirements

#### المتطلب الوظيفي 1: إنشاء التقييمات
- **FR-1.1:** يجب أن يكون الطلب في حالة "مكتمل" (completed) قبل السماح بإنشاء تقييم. لا يمكن التقييم للطلبات النشطة أو المعلقة.
- **FR-1.2:** يجب أن يكون المستخدم مشاركاً فعلياً في الطلب (صاحب الطلب الأصلي أو مقدم الخدمة الذي تم قبول عرضه)
- **FR-1.3:** يجب أن يكون التقييم رقماً صحيحاً بين 1 و 5 نجوم فقط (1 = سيء جداً، 5 = ممتاز)
- **FR-1.4:** التعليق النصي اختياري لكن موصى به بشدة. إذا تم إدخال تعليق، يجب أن يكون الحد الأدنى 10 أحرف والحد الأقصى 1000 حرف
- **FR-1.5:** يجب منع التقييمات المكررة تماماً (نفس المستخدم لا يمكنه تقييم نفس الشخص مرتين لنفس الطلب)
- **FR-1.6:** يجب السماح بتعديل التقييم خلال 24 ساعة من إنشائه فقط. بعد 24 ساعة، يصبح التقييم نهائياً
- **FR-1.7:** يجب إرسال إشعار فوري للمستخدم المقيم عند استقبال تقييم جديد

#### المتطلب الوظيفي 2: عرض التقييمات والمراجعات
- **FR-2.1:** عرض جميع المراجعات التي تلقاها المستخدم في الملف الشخصي بشكل منظم وواضح
- **FR-2.2:** عرض متوسط التقييم الإجمالي وعدد المراجعات الكلي بشكل بارز في أعلى قسم المراجعات
- **FR-2.3:** عرض توزيع التقييمات بشكل مرئي (رسم بياني دائري أو شريطي أو قائمة) يوضح عدد المراجعات لكل مستوى (5 نجوم، 4 نجوم، إلخ)
- **FR-2.4:** عرض المراجعات مرتبة حسب التاريخ (الأحدث أولاً) بشكل افتراضي مع إمكانية تغيير الترتيب
- **FR-2.5:** عرض تفاصيل الطلب المرتبط بكل مراجعة (رابط قابل للنقر يفتح صفحة تفاصيل الطلب)
- **FR-2.6:** عرض اسم وصورة كاتب كل مراجعة بشكل واضح
- **FR-2.7:** دعم التصفح عبر الصفحات (Pagination) إذا كان عدد المراجعات كبيراً (10 مراجعات لكل صفحة)

#### المتطلب الوظيفي 3: إدارة التقييمات
- **FR-3.1:** السماح بتعديل التقييم (النجوم والتعليق) خلال 24 ساعة من إنشائه فقط. بعد 24 ساعة، يظهر زر "تم التعديل" بدلاً من زر "تعديل"
- **FR-3.2:** السماح بحذف التقييم بالكامل (فقط منشئ التقييم يمكنه الحذف). يجب طلب تأكيد قبل الحذف
- **FR-3.3:** إشعار فوري للمستخدم المقيم عند استقبال تقييم جديد (إشعار داخل التطبيق + إشعار push)
- **FR-3.4:** إشعار المستخدم المقيم عند تعديل أو حذف تقييم (اختياري، يمكن تعطيله من الإعدادات)
- **FR-3.5:** عرض تاريخ إنشاء وتعديل التقييم بشكل واضح ("منذ 3 أيام" أو "تم التعديل منذ ساعة")

#### المتطلب الوظيفي 4: التصفية والبحث
- **FR-4.1:** تصفية مقدمي الخدمات حسب متوسط التقييم في صفحة "اكتشف" (مثال: عرض فقط من لديهم 4+ نجوم أو 5 نجوم فقط)
- **FR-4.2:** ترتيب مقدمي الخدمات حسب التقييم (الأعلى تقييماً أولاً أو الأقل تقييماً أولاً) مع إمكانية الجمع مع ترتيبات أخرى (الأحدث، الأقدم)
- **FR-4.3:** تصفية المراجعات في الملف الشخصي حسب مستوى التقييم (5 نجوم فقط، 4+ نجوم، إلخ)
- **FR-4.4:** البحث في نص المراجعات (البحث في التعليقات النصية) مع إبراز النتائج المطابقة
- **FR-4.5:** إمكانية الجمع بين عدة فلاتر في نفس الوقت (التقييم + المدينة + التصنيف)

### Non-Functional Requirements

#### المتطلب غير الوظيفي 1: الأمان والخصوصية
- **NFR-1.1:** يجب تطبيق Row Level Security (RLS) بشكل كامل على جدول التقييمات في Supabase لمنع الوصول غير المصرح به
- **NFR-1.2:** يجب التحقق من صحة البيانات على مستوى قاعدة البيانات (Database constraints) وواجهة المستخدم (Client validation) قبل السماح بإنشاء تقييم
- **NFR-1.3:** يجب منع التقييمات المزيفة تماماً (التقييم مسموح فقط بعد إتمام العمل - status = 'completed')
- **NFR-1.4:** يجب حماية قوية من التقييمات المكررة باستخدام UNIQUE constraint في قاعدة البيانات (نفس المستخدم لنفس الطلب)
- **NFR-1.5:** يجب تطبيق Rate Limiting لمنع إنشاء تقييمات كثيرة في وقت قصير (حماية من السبام)
- **NFR-1.6:** يجب تشفير البيانات الحساسة وحماية معلومات المستخدمين

#### المتطلب غير الوظيفي 2: الأداء والسرعة
- **NFR-2.1:** يجب تحميل التقييمات بشكل lazy (عند الطلب) باستخدام pagination لتقليل وقت التحميل الأولي
- **NFR-2.2:** يجب تخزين متوسط التقييمات محسوب مسبقاً في جدول منفصل (user_ratings) يتم تحديثه تلقائياً عند إنشاء/تعديل/حذف تقييم
- **NFR-2.3:** يجب أن يكون وقت تحميل صفحة الملف الشخصي < 1 ثانية حتى مع وجود 100+ مراجعة
- **NFR-2.4:** يجب استخدام Indexes على الأعمدة المستخدمة في الاستعلامات (reviewee_id, request_id, created_at)
- **NFR-2.5:** يجب تحسين استعلامات قاعدة البيانات لتجنب N+1 queries
- **NFR-2.6:** يجب استخدام Caching للمراجعات الشائعة عند الإمكان

#### المتطلب غير الوظيفي 3: تجربة المستخدم والواجهة
- **NFR-3.1:** يجب أن تكون واجهة إنشاء التقييم بسيطة وواضحة وسهلة الاستخدام حتى للمستخدمين غير التقنيين
- **NFR-3.2:** يجب أن تكون المراجعات قابلة للقراءة بشكل ممتاز مع دعم كامل لـ RTL (من اليمين لليسار)
- **NFR-3.3:** يجب أن تكون الأيقونات والنجوم واضحة ومفهومة مع دعم الوضع الداكن والفاتح
- **NFR-3.4:** يجب أن تكون جميع الرسائل والتنبيهات والأخطاء بالعربية مع إمكانية الترجمة للإنجليزية
- **NFR-3.5:** يجب أن تكون واجهة التقييم متجاوبة بالكامل (تعمل بشكل ممتاز على الموبايل والتابلت والديسكتوب)
- **NFR-3.6:** يجب أن تكون التفاعلات سلسة مع استخدام animations مناسبة (Framer Motion)
- **NFR-3.7:** يجب أن تكون رسائل الخطأ والنجاح واضحة ومفيدة للمستخدم

#### المتطلب غير الوظيفي 4: التوافقية والوصولية
- **NFR-4.1:** يجب أن يعمل النظام بشكل ممتاز على جميع الأجهزة (موبايل، تابلت، ديسكتوب) مع تصميم متجاوب بالكامل
- **NFR-4.2:** يجب أن يدعم الوضع الداكن والفاتح بشكل كامل مع تبديل سلس بينهما
- **NFR-4.3:** يجب أن يدعم RTL (العربية) و LTR (الإنجليزية) بشكل كامل مع تبديل تلقائي حسب اللغة
- **NFR-4.4:** يجب أن يكون النظام متوافقاً مع معايير الوصولية (Accessibility) - دعم قارئات الشاشة، التنقل بالكيبورد، إلخ
- **NFR-4.5:** يجب أن يعمل النظام على جميع المتصفحات الحديثة (Chrome, Firefox, Safari, Edge)

---

## Acceptance Criteria

### AC-1: إنشاء تقييم لمقدم الخدمة
- [ ] يمكن لصاحب الطلب تقييم مقدم الخدمة فقط بعد إتمام الطلب
- [ ] يمكن اختيار تقييم من 1 إلى 5 نجوم
- [ ] يمكن كتابة تعليق نصي (اختياري، الحد الأدنى 10 أحرف)
- [ ] يتم حفظ التقييم في قاعدة البيانات
- [ ] يتم تحديث متوسط تقييم مقدم الخدمة تلقائياً
- [ ] يتم إرسال إشعار لمقدم الخدمة

### AC-2: إنشاء تقييم لصاحب الطلب
- [ ] يمكن لمقدم الخدمة تقييم صاحب الطلب فقط بعد إتمام الطلب
- [ ] يمكن اختيار تقييم من 1 إلى 5 نجوم
- [ ] يمكن كتابة تعليق نصي (اختياري)
- [ ] يتم حفظ التقييم في قاعدة البيانات
- [ ] يتم تحديث متوسط تقييم صاحب الطلب تلقائياً
- [ ] يتم إرسال إشعار لصاحب الطلب

### AC-3: عرض المراجعات في الملف الشخصي
- [ ] تظهر جميع المراجعات في الملف الشخصي
- [ ] تظهر المراجعات مرتبة حسب التاريخ (الأحدث أولاً)
- [ ] يظهر متوسط التقييم وعدد المراجعات
- [ ] يمكن النقر على مراجعة لرؤية تفاصيل الطلب المرتبط
- [ ] المراجعات تدعم RTL وتظهر بشكل صحيح

### AC-4: إحصائيات التقييمات
- [ ] يظهر متوسط التقييم (مثال: 4.5 من 5)
- [ ] يظهر عدد المراجعات الإجمالي
- [ ] يظهر توزيع التقييمات (كم مراجعة لكل مستوى)
- [ ] الإحصائيات محدثة في الوقت الفعلي

### AC-5: تعديل وحذف التقييمات
- [ ] يمكن تعديل التقييم خلال 24 ساعة من إنشائه
- [ ] يمكن حذف التقييم (فقط منشئ التقييم)
- [ ] يتم تحديث الإحصائيات تلقائياً بعد التعديل/الحذف
- [ ] يتم إرسال إشعار للمستخدم المقيم عند التعديل/الحذف

### AC-6: التصفية والبحث
- [ ] يمكن تصفية مقدمي الخدمات حسب متوسط التقييم
- [ ] يمكن ترتيب مقدمي الخدمات حسب التقييم
- [ ] يمكن تصفية المراجعات حسب التقييم
- [ ] يمكن البحث في نص المراجعات

---

## Technical Considerations

### Database Schema

#### جدول `reviews`
```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID NOT NULL REFERENCES requests(id) ON DELETE CASCADE,
  reviewer_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  reviewee_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(request_id, reviewer_id) -- منع التقييمات المكررة
);

-- Indexes
CREATE INDEX idx_reviews_reviewee_id ON reviews(reviewee_id);
CREATE INDEX idx_reviews_request_id ON reviews(request_id);
CREATE INDEX idx_reviews_created_at ON reviews(created_at DESC);

-- RLS Policies
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;

-- يمكن للجميع قراءة المراجعات
CREATE POLICY "Anyone can read reviews"
  ON reviews FOR SELECT
  USING (true);

-- يمكن للمستخدمين إنشاء مراجعات فقط للطلبات المكتملة
CREATE POLICY "Users can create reviews for completed requests"
  ON reviews FOR INSERT
  WITH CHECK (
    auth.uid() = reviewer_id AND
    EXISTS (
      SELECT 1 FROM requests
      WHERE id = request_id
      AND status = 'completed'
      AND (author_id = reviewer_id OR EXISTS (
        SELECT 1 FROM offers
        WHERE request_id = reviews.request_id
        AND provider_id = reviewer_id
        AND status = 'accepted'
      ))
    )
  );

-- يمكن للمستخدمين تعديل مراجعاتهم خلال 24 ساعة
CREATE POLICY "Users can update their reviews within 24 hours"
  ON reviews FOR UPDATE
  USING (
    auth.uid() = reviewer_id AND
    created_at > NOW() - INTERVAL '24 hours'
  );

-- يمكن للمستخدمين حذف مراجعاتهم
CREATE POLICY "Users can delete their reviews"
  ON reviews FOR DELETE
  USING (auth.uid() = reviewer_id);
```

#### جدول `user_ratings` (Materialized View أو Table)
```sql
-- جدول لتخزين متوسط التقييمات (يتم تحديثه تلقائياً)
CREATE TABLE user_ratings (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  average_rating NUMERIC(3, 2) DEFAULT 0.00,
  total_reviews INTEGER DEFAULT 0,
  five_star_count INTEGER DEFAULT 0,
  four_star_count INTEGER DEFAULT 0,
  three_star_count INTEGER DEFAULT 0,
  two_star_count INTEGER DEFAULT 0,
  one_star_count INTEGER DEFAULT 0,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Function لتحديث user_ratings تلقائياً
CREATE OR REPLACE FUNCTION update_user_ratings()
RETURNS TRIGGER AS $$
BEGIN
  -- تحديث إحصائيات المستخدم المقيم (reviewee_id)
  INSERT INTO user_ratings (user_id, average_rating, total_reviews, 
    five_star_count, four_star_count, three_star_count, two_star_count, one_star_count, updated_at)
  SELECT
    reviewee_id,
    ROUND(AVG(rating)::numeric, 2),
    COUNT(*),
    COUNT(*) FILTER (WHERE rating = 5),
    COUNT(*) FILTER (WHERE rating = 4),
    COUNT(*) FILTER (WHERE rating = 3),
    COUNT(*) FILTER (WHERE rating = 2),
    COUNT(*) FILTER (WHERE rating = 1),
    NOW()
  FROM reviews
  WHERE reviewee_id = NEW.reviewee_id
  GROUP BY reviewee_id
  ON CONFLICT (user_id) DO UPDATE SET
    average_rating = EXCLUDED.average_rating,
    total_reviews = EXCLUDED.total_reviews,
    five_star_count = EXCLUDED.five_star_count,
    four_star_count = EXCLUDED.four_star_count,
    three_star_count = EXCLUDED.three_star_count,
    two_star_count = EXCLUDED.two_star_count,
    one_star_count = EXCLUDED.one_star_count,
    updated_at = NOW();
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger لتحديث user_ratings عند إنشاء/تعديل/حذف تقييم
CREATE TRIGGER trigger_update_user_ratings
  AFTER INSERT OR UPDATE OR DELETE ON reviews
  FOR EACH ROW
  EXECUTE FUNCTION update_user_ratings();
```

### TypeScript Types

```typescript
// Update existing Review interface in types.ts
export interface Review {
  id: string;
  requestId: string;
  reviewerId: string;
  revieweeId: string;
  reviewerName: string;
  reviewerAvatar?: string;
  rating: number; // 1-5
  comment?: string;
  createdAt: Date;
  updatedAt?: Date;
  // Related request info
  requestTitle?: string;
  requestStatus?: string;
}

export interface UserRating {
  userId: string;
  averageRating: number; // 0.00 - 5.00
  totalReviews: number;
  fiveStarCount: number;
  fourStarCount: number;
  threeStarCount: number;
  twoStarCount: number;
  oneStarCount: number;
  updatedAt: Date;
}
```

### Components

#### 1. `ReviewForm.tsx`
- نموذج لإنشاء/تعديل تقييم
- اختيار النجوم (1-5)
- حقل نصي للتعليق
- التحقق من صحة البيانات
- دعم RTL

#### 2. `ReviewCard.tsx`
- عرض مراجعة واحدة
- النجوم، التعليق، التاريخ، اسم الكاتب
- رابط للطلب المرتبط
- دعم RTL

#### 3. `ReviewsList.tsx`
- قائمة المراجعات
- تصفية حسب التقييم
- ترتيب حسب التاريخ
- Pagination

#### 4. `RatingStats.tsx`
- عرض إحصائيات التقييمات
- متوسط التقييم
- توزيع التقييمات (رسم بياني)
- عدد المراجعات

#### 5. `StarRatingInput.tsx`
- إدخال تقييم بالنجوم (قابل للتعديل)
- تفاعلي (hover effects)
- دعم RTL

### Services

#### `reviewsService.ts`
```typescript
// Functions:
- createReview(review: CreateReviewInput): Promise<Review>
- updateReview(reviewId: string, updates: UpdateReviewInput): Promise<Review>
- deleteReview(reviewId: string): Promise<void>
- getReviewsForUser(userId: string, filters?: ReviewFilters): Promise<Review[]>
- getReviewById(reviewId: string): Promise<Review>
- getUserRating(userId: string): Promise<UserRating>
- canUserReviewRequest(userId: string, requestId: string): Promise<boolean>
```

### Edge Cases

1. **تقييم مكرر:** منع التقييمات المكررة باستخدام UNIQUE constraint
2. **تعديل بعد 24 ساعة:** منع التعديل بعد 24 ساعة باستخدام RLS policy
3. **طلب غير مكتمل:** منع التقييم للطلبات غير المكتملة
4. **مستخدم غير مشارك:** منع التقييم من مستخدمين غير مشاركين في الطلب
5. **حذف طلب:** حذف المراجعات المرتبطة تلقائياً (CASCADE)
6. **حذف مستخدم:** حذف المراجعات المرتبطة تلقائياً (CASCADE)

### Security Considerations

1. **RLS Policies:** تطبيق Row Level Security على جميع العمليات
2. **Validation:** التحقق من صحة البيانات على Client و Server
3. **Rate Limiting:** منع إنشاء تقييمات كثيرة في وقت قصير
4. **Spam Protection:** كشف ومنع التقييمات المزيفة/السبام

### Performance Considerations

1. **Materialized View:** استخدام جدول `user_ratings` لتخزين الإحصائيات محسوبة مسبقاً
2. **Indexes:** إنشاء indexes على الأعمدة المستخدمة في الاستعلامات
3. **Pagination:** استخدام pagination لعرض المراجعات
4. **Lazy Loading:** تحميل المراجعات عند الطلب (lazy loading)

### Testing Requirements

1. **Unit Tests:** اختبار functions و components
2. **Integration Tests:** اختبار التكامل مع Supabase
3. **E2E Tests:** اختبار سيناريوهات المستخدم الكاملة
4. **Security Tests:** اختبار RLS policies و validation

---

## Dependencies

- **Supabase:** قاعدة البيانات والـ RLS
- **React 18:** واجهة المستخدم
- **TypeScript:** Type safety
- **StarRating Component:** موجود بالفعل في `components/ui/StarRating.tsx`
- **Notification System:** لإرسال إشعارات عند استقبال تقييمات جديدة
- **Request Status Management:** للتحقق من حالة الطلب (completed)

---

## Assumptions and Constraints

### Assumptions
1. المستخدمون يريدون تقييم بعضهم البعض بعد إتمام العمل
2. التقييمات ستكون مفيدة لمساعدة المستخدمين في اختيار مقدمي خدمات موثوقين
3. المستخدمون سيكتبون تعليقات مفيدة وليس فقط تقييمات

### Constraints
1. يمكن التقييم فقط بعد إتمام الطلب (status = 'completed')
2. يمكن تعديل التقييم فقط خلال 24 ساعة من إنشائه
3. لا يمكن تقييم نفس الشخص مرتين لنفس الطلب
4. يجب أن يكون المستخدم مشاركاً في الطلب (صاحب طلب أو مقدم خدمة معتمد)

---

## مؤشرات النجاح

### مؤشرات الاستخدام
1. **معدل التبني (Adoption Rate):** نسبة المستخدمين الذين يتركون تقييمات بعد إتمام العمل (الهدف: 60%+)
2. **معدل الاستجابة (Response Rate):** نسبة المستخدمين الذين يردون على طلب التقييم (الهدف: 70%+)

### مؤشرات الجودة
3. **جودة المراجعات (Review Quality):** متوسط طول التعليقات النصية (الهدف: 50+ حرف)
4. **معدل المراجعات المفيدة:** نسبة المراجعات التي تحتوي على تعليقات نصية (الهدف: 80%+)

### مؤشرات الأداء التقني
5. **وقت الاستجابة (Response Time):** وقت استجابة النظام لإنشاء/عرض التقييمات (الهدف: < 500ms)
6. **وقت التحميل (Load Time):** وقت تحميل صفحة المراجعات (الهدف: < 1 ثانية)

### مؤشرات رضا المستخدمين
7. **رضا المستخدمين:** رضا المستخدمين عن نظام التقييمات (الهدف: 4+ نجوم من 5)
8. **معدل الاستخدام المتكرر:** نسبة المستخدمين الذين يستخدمون النظام بانتظام (الهدف: 40%+ شهرياً)

---

## التحسينات المستقبلية

### المرحلة التالية (Phase 3)
1. **مراجعات بالصور:** إضافة إمكانية رفع صور للمراجعات لإثبات جودة العمل
2. **ردود الفعل على المراجعات:** إضافة أزرار "مفيد" و "غير مفيد" للمراجعات
3. **نظام المراجعة (Moderation):** نظام لمراجعة المراجعات قبل النشر (حماية من المحتوى المسيء)
4. **تحليلات متقدمة:** تحليلات شاملة للمراجعات (أكثر الكلمات استخداماً، الاتجاهات، إلخ)

### تحسينات إضافية
5. **قوالب جاهزة:** قوالب جاهزة للمراجعات لتسهيل الكتابة
6. **الترجمة التلقائية:** ترجمة تلقائية للمراجعات بين العربية والإنجليزية
7. **الإشعارات الذكية:** تذكيرات ذكية للمستخدمين لترك تقييمات بعد إتمام العمل
8. **نظام المكافآت:** مكافآت للمستخدمين الذين يتركون مراجعات مفيدة

---

## الملاحظات النهائية

- هذه المواصفات قابلة للتحديث بناءً على ملاحظات الفريق والمستخدمين
- يجب مراجعة المواصفات مع فريق التطوير قبل البدء بالتنفيذ
- يجب اختبار النظام بشكل شامل قبل الإطلاق

---

**آخر تحديث:** 2025-01-27  
**الحالة:** جاهز للمراجعة (Ready for Review)  
**الإصدار:** 1.0.0
