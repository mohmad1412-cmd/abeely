# اختبار نظام قبول العروض وإكمال الطلبات

## نظرة عامة

هذا الملف يحتوي على سيناريوهات اختبار شاملة لنظام قبول العروض وإكمال الطلبات الذي تم إصلاحه.

**التاريخ:** 2025-01-27  
**الحالة:** جاهز للاختبار

---

## الاختبارات اليدوية

### اختبار 1: قبول عرض (صاحب الطلب)

**السيناريو:**
1. تسجيل الدخول كصاحب طلب
2. إنشاء طلب جديد
3. انتظار وصول عرض (أو إنشاء عرض تجريبي)
4. فتح صفحة تفاصيل الطلب
5. النقر على زر "قبول العرض"

**النتائج المتوقعة:**
- ✅ يتم قبول العرض بنجاح
- ✅ حالة العرض تتغير إلى "accepted"
- ✅ العروض الأخرى ترفض تلقائياً
- ✅ حالة الطلب تتغير إلى "assigned"
- ✅ يظهر زر "تم إكمال الطلب"
- ✅ يتم إرسال إشعار لمقدم الخدمة

**التحقق:**
- [ ] رسالة نجاح تظهر
- [ ] حالة الطلب في قاعدة البيانات = "assigned"
- [ ] حالة العرض المقبول = "accepted"
- [ ] العروض الأخرى = "rejected"
- [ ] إشعار يصل لمقدم الخدمة

---

### اختبار 2: إكمال الطلب (صاحب الطلب)

**السيناريو:**
1. بعد قبول عرض (الاختبار 1)
2. النقر على زر "تم إكمال الطلب"
3. تأكيد الإكمال

**النتائج المتوقعة:**
- ✅ يتم إكمال الطلب بنجاح
- ✅ حالة الطلب تتغير إلى "completed"
- ✅ يتم إرسال إشعارات للطرفين
- ✅ الزر يختفي بعد الإكمال

**التحقق:**
- [ ] رسالة نجاح تظهر
- [ ] حالة الطلب في قاعدة البيانات = "completed"
- [ ] إشعار يصل لصاحب الطلب
- [ ] إشعار يصل لمقدم الخدمة
- [ ] الزر يختفي

---

### اختبار 3: إكمال الطلب (مقدم الخدمة)

**السيناريو:**
1. تسجيل الدخول كمقدم خدمة
2. فتح طلب تم قبول عرضه (status = "assigned")
3. النقر على زر "تم إكمال الطلب"

**النتائج المتوقعة:**
- ✅ يتم إكمال الطلب بنجاح
- ✅ حالة الطلب تتغير إلى "completed"
- ✅ يتم إرسال إشعارات للطرفين

**التحقق:**
- [ ] رسالة نجاح تظهر
- [ ] حالة الطلب = "completed"
- [ ] إشعارات تصل للطرفين

---

### اختبار 4: محاولة قبول عرض بدون صلاحيات

**السيناريو:**
1. تسجيل الدخول كمستخدم عادي (ليس صاحب الطلب)
2. محاولة قبول عرض على طلب ليس له

**النتائج المتوقعة:**
- ❌ يتم رفض العملية
- ❌ رسالة خطأ: "غير مصرح لك بقبول هذا العرض"

**التحقق:**
- [ ] رسالة خطأ تظهر
- [ ] لا يتم تحديث حالة العرض
- [ ] لا يتم تحديث حالة الطلب

---

### اختبار 5: محاولة إكمال طلب غير معين

**السيناريو:**
1. محاولة إكمال طلب في حالة "active" (لم يتم قبول عرض بعد)

**النتائج المتوقعة:**
- ❌ يتم رفض العملية
- ❌ رسالة خطأ: "لا يمكن إكمال الطلب إلا بعد قبول عرض"

**التحقق:**
- [ ] رسالة خطأ تظهر
- [ ] لا يتم تحديث حالة الطلب

---

### اختبار 6: محاولة إكمال طلب بدون صلاحيات

**السيناريو:**
1. تسجيل الدخول كمستخدم عادي (ليس صاحب الطلب ولا مقدم الخدمة المعتمد)
2. محاولة إكمال طلب

**النتائج المتوقعة:**
- ❌ يتم رفض العملية
- ❌ رسالة خطأ: "غير مصرح لك بإكمال هذا الطلب"

**التحقق:**
- [ ] رسالة خطأ تظهر
- [ ] لا يتم تحديث حالة الطلب

---

### اختبار 7: قبول عرض على طلب مكتمل

**السيناريو:**
1. محاولة قبول عرض على طلب في حالة "completed"

**النتائج المتوقعة:**
- ❌ يتم رفض العملية
- ❌ رسالة خطأ: "لا يمكن قبول عرض على طلب مكتمل أو مؤرشف"

**التحقق:**
- [ ] رسالة خطأ تظهر
- [ ] لا يتم تحديث حالة العرض

---

### اختبار 8: قبول عرض مرفوض مسبقاً

**السيناريو:**
1. محاولة قبول عرض في حالة "rejected"

**النتائج المتوقعة:**
- ❌ يتم رفض العملية
- ❌ رسالة خطأ: "هذا العرض تم قبوله أو رفضه مسبقاً"

**التحقق:**
- [ ] رسالة خطأ تظهر
- [ ] لا يتم تحديث حالة العرض

---

## الاختبارات الآلية (Unit Tests)

### Test 1: acceptOffer - Success Case

```typescript
describe('acceptOffer', () => {
  it('should accept an offer successfully', async () => {
    const requestId = 'test-request-id';
    const offerId = 'test-offer-id';
    const userId = 'test-user-id';

    // Mock Supabase responses
    // ... setup mocks

    const result = await acceptOffer(requestId, offerId, userId);

    expect(result.success).toBe(true);
    expect(result.error).toBeUndefined();
  });
});
```

### Test 2: acceptOffer - Invalid User

```typescript
it('should reject if user is not the request owner', async () => {
  const result = await acceptOffer(requestId, offerId, 'wrong-user-id');

  expect(result.success).toBe(false);
  expect(result.error).toContain('غير مصرح لك');
});
```

### Test 3: completeRequest - Success Case

```typescript
describe('completeRequest', () => {
  it('should complete a request successfully', async () => {
    const requestId = 'test-request-id';
    const userId = 'test-user-id';

    const result = await completeRequest(requestId, userId);

    expect(result.success).toBe(true);
    expect(result.error).toBeUndefined();
  });
});
```

### Test 4: completeRequest - Invalid Status

```typescript
it('should reject if request is not in assigned status', async () => {
  // Mock request with status 'active'
  const result = await completeRequest(requestId, userId);

  expect(result.success).toBe(false);
  expect(result.error).toContain('لا يمكن إكمال الطلب');
});
```

---

## قائمة التحقق النهائية

### الوظائف الأساسية
- [ ] قبول عرض يعمل بشكل صحيح
- [ ] إكمال الطلب يعمل بشكل صحيح
- [ ] الإشعارات تُرسل بشكل صحيح
- [ ] تحديثات الحالة تعمل بشكل صحيح

### الأمان
- [ ] التحقق من الصلاحيات يعمل
- [ ] RLS policies تعمل بشكل صحيح
- [ ] لا يمكن التلاعب بالحالات

### تجربة المستخدم
- [ ] رسائل الخطأ واضحة
- [ ] رسائل النجاح واضحة
- [ ] UI يتحدث بشكل صحيح
- [ ] الإشعارات تظهر بشكل صحيح

### الأداء
- [ ] العمليات سريعة (< 1 ثانية)
- [ ] لا توجد أخطاء في Console
- [ ] لا توجد memory leaks

---

## سجلات الاختبار

### اختبار 1: [تاريخ]
**النتيجة:** ✅ نجح / ❌ فشل  
**الملاحظات:** ...

### اختبار 2: [تاريخ]
**النتيجة:** ✅ نجح / ❌ فشل  
**الملاحظات:** ...

---

## المشاكل المكتشفة

### مشكلة 1: [عنوان]
**الوصف:** ...  
**الأولوية:** عالية / متوسطة / منخفضة  
**الحالة:** مفتوحة / قيد الإصلاح / تم الإصلاح

---

**آخر تحديث:** 2025-01-27
