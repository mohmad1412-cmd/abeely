# ุชูุถูุญ ุงููุตู ุจูู `request_views` ู `request_view_logs`

## ๐ ุงูููุฎุต ุงูุชูููุฐู

ููุงู ุฌุฏููุงู ูููุตูุงู ูุชุชุจุน ุงููุดุงูุฏุงุชุ ูููู ููููุง ุบุฑุถ ูุฎุชูู ุชูุงูุงู:

| ุงูุฌุฏูู | ุงูุฌูููุฑ ุงููุณุชูุฏู | ุงูุบุฑุถ ุงูุฑุฆูุณู | ุนุฏุฏ ุงูุณุฌูุงุช (ุญุงููุงู) |
|--------|------------------|---------------|---------------------|
| **`request_views`** | ุงููุณุชุฎุฏููู ุงููุณุฌููู ููุท | ุชุชุจุน ุญุงูุฉ ุงููุฑุงุกุฉ (viewed/read) | ~35 |
| **`request_view_logs`** | ุงูุฌููุน (ุฒูุงุฑ + ูุณุฌููู) | ุฅุญุตุงุก ุงููุดุงูุฏุงุช ุงูุฅุฌูุงูู | ~12,376+ |

---

## ๐ `request_views` - ุชุชุจุน ุญุงูุฉ ุงููุฑุงุกุฉ (ูููุณุชุฎุฏููู ุงููุณุฌููู ููุท)

### ุงูุบุฑุถ
ุชุชุจุน ุญุงูุฉ ุงููุฑุงุกุฉ ูููุณุชุฎุฏููู ุงููุณุฌููู ููุท. ููุณุชุฎุฏู ูุชุญุฏูุฏ:
- โ ุงูุทูุจุงุช ุงูุชู ุดุงูุฏูุง ุงููุณุชุฎุฏู (`viewed_at`)
- โ ุงูุทูุจุงุช ุงูุชู ูุฑุฃูุง ุงููุณุชุฎุฏู ุจุงููุงูู (`is_read`, `read_at`)
- โ ุญุณุงุจ ุนุฏุฏ ุงูุทูุจุงุช ุบูุฑ ุงูููุฑูุกุฉ ูู "ูู ุงูุชูุงูุงุชู" (`get_unread_interests_count`)
- โ ุฅุฎูุงุก ุงูู badge ุนูุฏ ูุฑุงุกุฉ ุงูุทูุจ

### ุงูุจููุฉ
```sql
CREATE TABLE request_views (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,              -- ูุทููุจ - ููุท ูููุณุชุฎุฏููู ุงููุณุฌููู
  request_id UUID NOT NULL,
  viewed_at TIMESTAMPTZ,              -- ุชุงุฑูุฎ ุฑุคูุฉ ุงููุงุฑุช
  is_read BOOLEAN DEFAULT FALSE,      -- ูู ูุฑุฃ ุงูุทูุจ ุจุงููุงููุ
  read_at TIMESTAMPTZ,                -- ุชุงุฑูุฎ ูุฑุงุกุฉ ุงูุทูุจ ุจุงููุงูู
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ,
  UNIQUE(user_id, request_id)         -- ุณุฌู ูุงุญุฏ ููู ูุณุชุฎุฏู/ุทูุจ
);
```

### ุงููููุฏ
- โ **ูุง ูุฏุนู ุงูุฒูุงุฑ** - `user_id` ูุทููุจ (NOT NULL)
- โ ูุงุญุฏ ููู ูุณุชุฎุฏู/ุทูุจ - `UNIQUE(user_id, request_id)`
- โ ูุณุชุฎุฏู `is_read` ูุชุญุฏูุฏ ุญุงูุฉ ุงููุฑุงุกุฉ

### ุงูุฏูุงู ุงููุณุชุฎุฏูุฉ
- `mark_request_viewed(request_id)` - ุนูุฏ ูุชุญ ุตูุญุฉ ุชูุงุตูู ุงูุทูุจ
- `mark_request_read(request_id)` - ุนูุฏ ุงูุชูุฑูุฑ 50%+ ูู ุงูุตูุญุฉ
- `get_unread_interests_count()` - ุญุณุงุจ ุงูุทูุจุงุช ุบูุฑ ุงูููุฑูุกุฉ

### ุงูุงุณุชุฎุฏุงู ูู ุงูููุฏ
```typescript
// services/requestViewsService.ts
markRequestAsViewed(requestId)    // ููุชุจ ูู request_views
markRequestAsRead(requestId)      // ูุญุฏุซ request_views
getUnreadInterestsCount()         // ููุฑุฃ ูู request_views
getViewedRequestIds()             // ููุฑุฃ ูู request_views (is_read = true)
```

---

## ๐ `request_view_logs` - ุฅุญุตุงุก ุงููุดุงูุฏุงุช (ููุฌููุน)

### ุงูุบุฑุถ
ุฅุญุตุงุก ุงููุดุงูุฏุงุช ุงูุฅุฌูุงูู ููุฌููุน (ุฒูุงุฑ ููุณุชุฎุฏููู ูุณุฌููู). ููุณุชุฎุฏู ูุชุญุฏูุฏ:
- โ ุนุฏุฏ ุงููุดุงูุฏุงุช ุงูุฅุฌูุงูู ููู ุทูุจ (`increment_request_views`)
- โ ุฅุญุตุงุฆูุงุช ุงููุดุงูุฏุงุช (`get_request_view_stats`):
  - ุฅุฌูุงูู ุงููุดุงูุฏุงุช
  - ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุณุฌููู (`user_id IS NOT NULL`)
  - ุนุฏุฏ ุงูุฒูุงุฑ (`user_id IS NULL`)
  - ุงููุดุงูุฏุงุช ูู ุขุฎุฑ 24 ุณุงุนุฉ / 7 ุฃูุงู
- โ ุชุชุจุน ุงููุดุงูุฏุงุช ุนุจุฑ `session_id` ูููุน ุงูุชูุฑุงุฑ

### ุงูุจููุฉ
```sql
CREATE TABLE request_view_logs (
  id UUID PRIMARY KEY,
  request_id UUID NOT NULL,
  session_id TEXT NOT NULL,          -- ูุนุฑู ุงูุฌูุณุฉ (ูู localStorage)
  user_id UUID NULL,                 -- ุงุฎุชูุงุฑู - NULL ููุฒูุงุฑ
  viewed_at TIMESTAMPTZ,
  ip_hash TEXT,                      -- hash ููู IP (ููุชุญููู)
  user_agent TEXT,                   -- ูุนูููุงุช ุงููุชุตูุญ
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ,
  UNIQUE(request_id, session_id)     -- ุณุฌู ูุงุญุฏ ููู ุทูุจ/ุฌูุณุฉ
);
```

### ุงููููุฏ
- โ **ูุฏุนู ุงูุฒูุงุฑ** - `user_id` ุงุฎุชูุงุฑู (NULLABLE)
- โ ูุงุญุฏ ููู ุทูุจ/ุฌูุณุฉ - `UNIQUE(request_id, session_id)`
- โ ูุณุชุฎุฏู `session_id` ูููุน ุชูุฑุงุฑ ุงูุนุฏ

### ุงูุฏูุงู ุงููุณุชุฎุฏูุฉ
- `increment_request_views(request_id, session_id, user_agent)` - ุนูุฏ ูุชุญ ุตูุญุฉ ุงูุชูุงุตูู
- `get_request_view_stats(request_id)` - ุฅุญุตุงุฆูุงุช ููุตูุฉ
- `get_request_view_count(request_id)` - ุนุฏุฏ ุงููุดุงูุฏุงุช ููุท

### ุงูุงุณุชุฎุฏุงู ูู ุงูููุฏ
```typescript
// services/requestViewsService.ts
incrementRequestViews(requestId)     // ููุชุจ ูู request_view_logs
getRequestViewCount(requestId)       // ููุฑุฃ ูู requests.view_count
getRequestViewStats(requestId)       // ููุฑุฃ ูู request_view_logs
```

---

## ๐ ุงููุฑู ุงูุฑุฆูุณู

| ุงูุฎุงุตูุฉ | `request_views` | `request_view_logs` |
|---------|----------------|---------------------|
| **ุงูุฌูููุฑ** | ูุณุฌููู ููุท โ | ุฒูุงุฑ + ูุณุฌููู โ |
| **user_id** | ูุทููุจ (NOT NULL) | ุงุฎุชูุงุฑู (NULLABLE) |
| **session_id** | โ ุบูุฑ ููุฌูุฏ | โ ููุฌูุฏ |
| **is_read** | โ ููุฌูุฏ | โ ุบูุฑ ููุฌูุฏ |
| **ุงูุบุฑุถ** | ุญุงูุฉ ุงููุฑุงุกุฉ | ุฅุญุตุงุก ุงููุดุงูุฏุงุช |
| **ุงูุงุณุชุฎุฏุงู** | Badge, "ูู ุงูุชูุงูุงุชู" | ุนุฑุถ ุงูุนุฏุงุฏ, Analytics |

---

## ๐ ูุซุงู ุนููู

### ุณููุงุฑูู: ุฒุงุฆุฑ ููุณุชุฎุฏู ูุณุฌู ูุดุงูุฏูู ููุณ ุงูุทูุจ

#### 1. ุงูุฒุงุฆุฑ (Guest):
```typescript
// โ ูููุชุจ ูู request_view_logs ููุท
incrementRequestViews(requestId)
// โ request_view_logs: { request_id, session_id, user_id: NULL, ... }
// โ requests.view_count: +1
```

#### 2. ุงููุณุชุฎุฏู ุงููุณุฌู (Authenticated):
```typescript
// โ ูููุชุจ ูู ููุง ุงูุฌุฏูููู
markRequestAsViewed(requestId)      // โ request_views
incrementRequestViews(requestId)    // โ request_view_logs
// โ request_views: { user_id, request_id, is_read: true, ... }
// โ request_view_logs: { request_id, session_id, user_id: <uuid>, ... }
// โ requests.view_count: +1
```

---

## ๐ฏ ููุงุนุฏ ุงูุงุณุชุฎุฏุงู

### โ ุงุณุชุฎุฏู `request_views` ุนูุฏูุง:
1. ุชุญุชุงุฌ ูุนุฑูุฉ ุฅุฐุง ูุฑุฃ ุงููุณุชุฎุฏู ุงููุณุฌู ุงูุทูุจ (`is_read`)
2. ุชุฑูุฏ ุญุณุงุจ ุนุฏุฏ ุงูุทูุจุงุช ุบูุฑ ุงูููุฑูุกุฉ (`get_unread_interests_count`)
3. ุชุฑูุฏ ุฅุฎูุงุก ุงูู badge ูู "ูู ุงูุชูุงูุงุชู"
4. **ุงููุณุชุฎุฏู ูุณุฌู ููุท** (ูุง ูุฏุนู ุงูุฒูุงุฑ)

### โ ุงุณุชุฎุฏู `request_view_logs` ุนูุฏูุง:
1. ุชุฑูุฏ ุฅุญุตุงุก ุงููุดุงูุฏุงุช ุงูุฅุฌูุงูู (ุฒูุงุฑ + ูุณุฌููู)
2. ุชุฑูุฏ ุฅุญุตุงุฆูุงุช ููุตูุฉ (24h, 7d, unique users, guests)
3. ุชุฑูุฏ ุนุฑุถ ุนุฏุงุฏ ุงููุดุงูุฏุงุช ูู ุตูุญุฉ ุงูุทูุจ
4. **ุงูุฌูููุฑ ุดุงูู ุงูุฒูุงุฑ**

---

## ๐ ููุฎุต ุงูุจูุงูุงุช ุงูุญุงููุฉ

ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุขุฎุฑ ูุญุต):
- **`request_views`**: 35 ุณุฌู (9 ูุณุชุฎุฏูููุ 12 ุทูุจุ 35 ูุฑุงุกุฉ)
- **`request_view_logs`**: 12,376+ ุณุฌู (9 ูุณุชุฎุฏููู ูุณุฌูููุ ุนุฏุฏ ูุจูุฑ ูู ุงูุฒูุงุฑ)

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ูุง ุชูุฌุฏ ุชูุฑุงุฑ**: ูู ุฌุฏูู ูู ุบุฑุถ ูุฎุชูู
2. **ุงูุชูุงูู ูููู**: ุนูุฏ ูุชุญ ุงูุทูุจุ ูููุชุจ ูู ููุง ุงูุฌุฏูููู (ูููุณุชุฎุฏููู ุงููุณุฌููู)
3. **ุงูุฃุฏุงุก**: `request_views` ุตุบูุฑ (35 ุณุฌู)ุ `request_view_logs` ูุจูุฑ (12K+ ุณุฌู)
4. **RLS**: ููุงููุง ูุญูู ุจู Row Level Security

---

## ๐๏ธ ุงูุตูุงูุฉ

### ุนุฑุถ ุงูููุฎุต:
```sql
SELECT * FROM request_views_summary;
```

### ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ (ุงุฎุชูุงุฑู):
```sql
-- ุญุฐู ุณุฌูุงุช request_view_logs ุงูุฃูุฏู ูู ุณูุฉ
DELETE FROM request_view_logs 
WHERE created_at < NOW() - INTERVAL '1 year';

-- ุญุฐู ุณุฌูุงุช request_views ูููุณุชุฎุฏููู ุงููุญุฐูููู (ูุญุฏุซ ุชููุงุฆูุงู ุจุณุจุจ CASCADE)
```

---

## ๐ ุงููุฑุงุฌุน

- `services/requestViewsService.ts` - ุงุณุชุฎุฏุงู ุงูุฌุฏูููู ูู ุงูููุฏ
- `supabase/migrations/2026012701_add_request_views_functions.sql` - ุชุนุฑูู ุงูุฏูุงู
- Migration: `clarify_request_views_separation` - ุชุนูููุงุช ุชูุถูุญูุฉ
