# سياسة تحديث الطلبات (Request Update Policy)

## نظرة عامة

عند تعديل طلب موجود، يتم التحقق من شروط مختلفة:
1. **شرط التعديل**: يجب ألا يتجاوز الطلب 7 أيام من تاريخ الإنشاء (يمنع التعديل تماماً)
2. **شرط تحديث `updated_at` (Bump)**: يتم تحديث `updated_at` إذا كان الطلب `active` ولم يتم قبول أي عرض

## شرط التعديل (7 أيام) ⏰

**لا يمكن تعديل الطلب إذا تجاوز 7 أيام من تاريخ الإنشاء**

### مثال على حساب الأيام:
```
تاريخ الإنشاء: 2024-01-01 10:00:00
تاريخ التعديل: 2024-01-05 15:30:00
الأيام المنقضية: 4.23 يوم ✅ (أقل من 7 أيام - مسموح التعديل)
```

```
تاريخ الإنشاء: 2024-01-01 10:00:00
تاريخ التعديل: 2024-01-10 15:30:00
الأيام المنقضية: 9.23 يوم ❌ (أكثر من 7 أيام - ممنوع التعديل تماماً)
```

**النتيجة**: إذا تجاوز الطلب 7 أيام، يتم رفض التعديل بالكامل (`return null`)

## شروط تحديث `updated_at` (Bump)

يتم تحديث `updated_at` تلقائياً عند تعديل الطلب **فقط** إذا تحققت الشروط التالية:

### 1. حالة الطلب (Status)
- ✅ يجب أن يكون الطلب في حالة `active`
- ❌ لا يمكن التحديث إذا كان الطلب في حالة:
  - `assigned` (تم تعيين مزود خدمة)
  - `completed` (تم إكمال الطلب)
  - `archived` (تم أرشفته)

### 2. عدم قبول أي عرض
- ✅ يجب ألا يكون هناك عرض مقبول على الطلب (`accepted_offer_id` = `null`)
- ❌ إذا تم قبول عرض، لا يمكن تحديث `updated_at` لأن الطلب أصبح في مرحلة التنفيذ

**ملاحظة مهمة**: شرط الـ 7 أيام **لا يؤثر** على تحديث `updated_at`. إذا كان التعديل مسموح (أقل من 7 أيام) وكان الطلب `active` ولم يتم قبول عرض، يتم تحديث `updated_at` دائماً.

## السلوك عند التعديل

### الحالة 1: التعديل مسموح + شروط Bump متوفرة ✅
```
✅ الأيام المنقضية: 3 أيام (أقل من 7)
✅ Status: active
✅ accepted_offer_id: null
```

**النتيجة**:
```typescript
// يتم تحديث:
- title
- description
- budget_min, budget_max, budget_type
- location
- delivery_from
- categories
- updated_at ← يتم تحديثه (bump)
```

الطلب يرتفع في القائمة لأنه تم تحديث `updated_at`

### الحالة 2: التعديل مسموح + شروط Bump غير متوفرة
```
✅ الأيام المنقضية: 3 أيام (أقل من 7)
❌ Status: assigned (أو completed/archived)
❌ accepted_offer_id: "offer-123"
```

**النتيجة**:
```typescript
// يتم تحديث:
- title
- description
- budget_min, budget_max, budget_type
- location
- delivery_from
- categories
- updated_at ← لا يتم تحديثه
```

يتم تحديث بيانات الطلب فقط، لكنه لا يرتفع في القائمة

### الحالة 3: التعديل ممنوع (تجاوز 7 أيام) ❌
```
❌ الأيام المنقضية: 10 أيام (أكثر من 7)
✅ Status: active
✅ accepted_offer_id: null
```

**النتيجة**: 
```
❌ التعديل مرفوض تماماً (return null)
❌ لا يتم تحديث أي شيء
```

## أمثلة عملية

### مثال 1: طلب جديد (يوم واحد) - تعديل + bump ✅
```
✅ الأيام المنقضية: 1 يوم (أقل من 7)
✅ Status: active
✅ accepted_offer_id: null
→ ✅ التعديل مسموح
→ ✅ يتم تحديث updated_at (bump)
```

### مثال 2: طلب قديم (10 أيام) - تعديل ممنوع ❌
```
❌ الأيام المنقضية: 10 أيام (أكثر من 7)
✅ Status: active
✅ accepted_offer_id: null
→ ❌ التعديل ممنوع تماماً
→ ❌ لا يتم تحديث أي شيء
```

### مثال 3: طلب تم قبول عرض عليه - تعديل مسموح لكن بدون bump
```
✅ الأيام المنقضية: 3 أيام (أقل من 7)
❌ Status: assigned
❌ accepted_offer_id: "offer-123"
→ ✅ التعديل مسموح
→ ❌ لا يتم تحديث updated_at (لأنه assigned أو تم قبول عرض)
```

### مثال 4: طلب مكتمل - تعديل مسموح لكن بدون bump
```
✅ الأيام المنقضية: 5 أيام (أقل من 7)
❌ Status: completed
✅ accepted_offer_id: "offer-123"
→ ✅ التعديل مسموح
→ ❌ لا يتم تحديث updated_at (لأنه completed)
```

## سبب شرط الـ 7 أيام للتعديل

1. **منع التلاعب بالطلبات القديمة**: بعد 7 أيام، يعتبر الطلب قديم ويجب إنشاء طلب جديد بدلاً من تعديل القديم
2. **الحفاظ على جودة السوق**: الطلبات القديمة قد تكون غير ذات صلة، والأفضل إنشاء طلب جديد
3. **منع التعديلات المتكررة**: منع المستخدمين من تعديل طلباتهم القديمة بشكل مستمر
4. **تشجيع الطلبات الجديدة**: دفع المستخدمين لإنشاء طلبات جديدة بدلاً من تعديل القديمة

## سبب تحديث `updated_at` (Bump)

عند تعديل طلب حديث (أقل من 7 أيام) وهو `active` ولم يتم قبول عرض:
- يتم تحديث `updated_at` لرفع الطلب في القائمة
- يعطي فرصة جديدة للطلب للظهور أمام المزودين
- يحفز المزودين على تقديم عروض جديدة

## تعديل فترة الـ 7 أيام

يمكن تعديل فترة الـ 7 أيام من خلال تغيير قيمة `MAX_UPDATE_DAYS` في ملف `services/requestsService.ts`:

```typescript
const MAX_UPDATE_DAYS = 7; // يمكن تغييرها إلى أي قيمة (مثلاً: 3, 14, 30)
```

## ملاحظات مهمة

- ⚠️ **شرط الـ 7 أيام يمنع التعديل**: إذا تجاوز الطلب 7 أيام، لا يمكن تعديله على الإطلاق
- ⚠️ **تحديث `updated_at` (Bump) مشروط**: يتم تحديث `updated_at` فقط إذا كان الطلب `active` ولم يتم قبول عرض (بغض النظر عن الـ 7 أيام)
- ⚠️ **التصنيفات دائماً تُحدث**: يتم تحديث التصنيفات دائماً عند التعديل (إذا كان التعديل مسموح)

## ملخص سريع

| الحالة | الأيام | Status | Accepted Offer | التعديل | تحديث `updated_at` |
|--------|--------|--------|----------------|---------|-------------------|
| 1 | < 7 | active | ❌ | ✅ | ✅ |
| 2 | < 7 | active | ✅ | ✅ | ❌ |
| 3 | < 7 | assigned | ❌ | ✅ | ❌ |
| 4 | > 7 | active | ❌ | ❌ | ❌ |
| 5 | > 7 | active | ✅ | ❌ | ❌ |
