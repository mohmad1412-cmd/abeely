# ุชุฃุซูุฑ ุฅุตูุงุญุงุช ุงูุฃูุงู ุนูู ุงูุชุทุจูู

## โ ุงูุฅุฌุงุจุฉ ุงููุฎุชุตุฑุฉ

**ุงูุฅุตูุงุญุงุช ุชุตูุญ ุงููุดุงูู ุงูุฃูููุฉ ููุง ุชุฎุฑุจ ุงูุนูู ุงูููุฌูุฏ** - ููู ููุงู **ุชุฃุซูุฑุงุช ุฅูุฌุงุจูุฉ** ูุฌุจ ููููุง.

---

## ๐ ุชุญููู ุงูุชุฃุซูุฑ

### 1. Function Search Path Mutable โ **ูุง ุชุฃุซูุฑ**

**ูุง ุชู ุชุบููุฑู:**
- ุฅุถุงูุฉ `SET search_path = public` ููุฏูุงู

**ุงูุชุฃุซูุฑ:**
- **ูุง ุชุฃุซูุฑ ุนูู ุงููุธููุฉ** - ุงูุฏูุงู ุชุนูู ุจููุณ ุงูุทุฑููุฉ
- **ููุท ุฒูุงุฏุฉ ูู ุงูุฃูุงู** - ููุน SQL injection attacks

**ุงูุฎูุงุตุฉ:** โ ุขูู ุชูุงูุงูุ ูุง ูุดุงูู

---

### 2. RLS Policies - requests (ุงูุทูุจุงุช) โ๏ธ **ุชุฃุซูุฑ ุฅูุฌุงุจู**

#### ูุจู ุงูุฅุตูุงุญ:
```sql
WITH CHECK (true)  -- ุฃู ุดุฎุต ููููู ุฅูุดุงุก ุทูุจุงุช
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```sql
WITH CHECK (
  auth.uid() IS NOT NULL 
  AND (author_id = auth.uid() OR author_id IS NULL)
)
```

**ุงูุชุญูู ูู ุงูููุฏ:**
```typescript
// services/requestsService.ts:318
payload.author_id = userId;  // โ ุงูููุฏ ูุถุน author_id ุจุดูู ุตุญูุญ
```

**ุงูุชุฃุซูุฑ:**
- โ **ูุนูู ุจุดูู ุตุญูุญ** - ุงูููุฏ ูุถุน `author_id` ูุจู ุงูุฅุฏุฑุงุฌ
- โ **ุฃูุซุฑ ุฃูุงูุงู** - ูููุน ุฅูุดุงุก ุทูุจุงุช ุจุงุณู ูุณุชุฎุฏููู ุขุฎุฑูู
- โ๏ธ **ููุงุญุธุฉ:** ุฅุฐุง ูุงู `userId !== auth.uid()`ุ ุณููุดู ุงูุฅุฏุฑุงุฌ (ููุฐุง ุตุญูุญ ุฃูููุงู)

**ุงูุฎูุงุตุฉ:** โ ูุง ูุดุงููุ ููุท ุฒูุงุฏุฉ ูู ุงูุฃูุงู

---

### 3. RLS Policies - reviews (ุงูุชููููุงุช) โ๏ธ **ุชุฃุซูุฑ ุฅูุฌุงุจู**

#### ูุจู ุงูุฅุตูุงุญ:
```sql
WITH CHECK (true)  -- ุฃู ุดุฎุต ููููู ุฅูุดุงุก/ุชุญุฏูุซ/ุญุฐู ุฃู review
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```sql
WITH CHECK (
  auth.uid() IS NOT NULL 
  AND (author_id = auth.uid() OR author_id IS NULL)
)
```

**ุงูุชุฃุซูุฑ:**
- โ **ุฃูุซุฑ ุฃูุงูุงู** - ูููุน ุชุนุฏูู/ุญุฐู ุชููููุงุช ุงูุขุฎุฑูู
- โ๏ธ **ูุญุชุงุฌ ูุญุต:** ุฅุฐุง ูุงู ุงูููุฏ ูุง ูุถุน `author_id` ุจุดูู ุตุญูุญุ ูุฏ ููุดู

**ุงูุฎูุงุตุฉ:** โ ุขููุ ููู ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู ุงูููุฏ ูุถุน `author_id` ุจุดูู ุตุญูุญ

---

### 4. RLS Policies - request_view_logs (ุณุฌูุงุช ุงููุดุงูุฏุงุช) โ **ูุง ุชุฃุซูุฑ**

#### ูุจู ุงูุฅุตูุงุญ:
```sql
WITH CHECK (true)  -- ุฃู ุดุฎุต ููููู ุฅุถุงูุฉ ุณุฌูุงุช
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```sql
WITH CHECK (
  auth.uid() IS NOT NULL 
  OR current_setting('request.jwt.claim.role', true) = 'service_role'
)
```

**ุงูุชุญูู ูู ุงูููุฏ:**
```typescript
// services/requestViewsService.ts:187
const { data, error } = await supabase.rpc('increment_request_views', {
  // ...
});
```

**ุงูููู:**
- ุงูุฏุงูุฉ `increment_request_views` ุชุณุชุฎุฏู `SECURITY DEFINER`
- ูุฐุง ูุนูู ุฃููุง ุชุนูู ุจุตูุงุญูุงุช `service_role`
- **ูุฐูู ุชุนูู ุญุชู ููุฒูุงุฑ (guests)**

**ุงูุชุฃุซูุฑ:**
- โ **ูุนูู ููุฌููุน** - ุงูุฏุงูุฉ ุชุณุชุฎุฏู `SECURITY DEFINER`
- โ๏ธ **ููุงุญุธุฉ:** ุฅุฐุง ูุงู ุงูููุฏ ูุญุงูู ุฅุฏุฑุงุฌ ูุจุงุดุฑ ูู `request_view_logs` (ุจุฏูู ุงูุฏุงูุฉ)ุ ุณููุดู ููุฒูุงุฑ

**ุงูุฎูุงุตุฉ:** โ ูุง ูุดุงูู ุฅุฐุง ุงุณุชุฎุฏูุช ุงูุฏุงูุฉ `increment_request_views`

---

### 5. RLS Policies - verified_guests โ **ุชุฃุซูุฑ ุฅูุฌุงุจู**

#### ูุจู ุงูุฅุตูุงุญ:
```sql
WITH CHECK (true)  -- ุฃู ุดุฎุต ููููู ุฅูุดุงุก ุณุฌูุงุช ุจุฏูู ูููุฏ
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```sql
WITH CHECK (
  phone IS NOT NULL 
  AND LENGTH(phone) >= 10
  AND verification_code IS NOT NULL 
  AND LENGTH(verification_code) >= 4
  AND code_expires_at > NOW()
)
```

**ุงูุชุฃุซูุฑ:**
- โ **ุฃูุซุฑ ุฃูุงูุงู** - ูุถูู ุตุญุฉ ุงูุจูุงูุงุช
- โ **ูุง ูุดุงูู** - ุงูููุฏ ูุฌุจ ุฃู ูุถุน ูุฐู ุงูููู ุจุดูู ุตุญูุญ

**ุงูุฎูุงุตุฉ:** โ ุขูู ุชูุงูุงู

---

### 6. RLS Policies - pending_categories โ๏ธ **ูุญุชุงุฌ ูุญุต**

#### ูุจู ุงูุฅุตูุงุญ:
```sql
USING (TRUE) WITH CHECK (TRUE)  -- ุฃู ุดุฎุต ููููู ุงูุชุนุฏูู
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```sql
USING (
  current_setting('request.jwt.claim.role', true) = 'service_role'
  OR auth.jwt() ->> 'role' = 'service_role'
)
```

**ุงูุชุฃุซูุฑ:**
- โ๏ธ **ูุญุชุงุฌ ูุญุต:** ุฅุฐุง ูุงู ุงูููุฏ ุฃู Edge Functions ุชุญุงูู ุชุนุฏูู `pending_categories` ุจุฏูู `service_role`ุ ุณุชูุดู
- โ **ุฃูุซุฑ ุฃูุงูุงู** - ูููุน ุงูุชุนุฏูู ุบูุฑ ุงููุตุฑุญ ุจู

**ุงูุฎูุงุตุฉ:** โ๏ธ ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู Edge Functions ุชุณุชุฎุฏู `service_role` ุนูุฏ ุงูุชุนุฏูู

---

## ๐งช ุงุฎุชุจุงุฑุงุช ููุชุฑุญุฉ

### 1. ุงุฎุชุจุงุฑ ุฅูุดุงุก ุทูุจ (ูุณุชุฎุฏู ูุณุฌู)
```typescript
// ูุฌุจ ุฃู ูุนูู
const { data, error } = await supabase
  .from('requests')
  .insert({
    author_id: userId,  // ูุฌุจ ุฃู ูููู = auth.uid()
    title: 'ุทูุจ ุชุฌุฑูุจู',
    // ...
  });
```

### 2. ุงุฎุชุจุงุฑ ุฅูุดุงุก ุทูุจ (ุฒุงุฆุฑ)
```typescript
// ูุฌุจ ุฃู ูุนูู ุฅุฐุง ูุงู:
// - is_guest_request = true
// - contact_phone_verified = true
const { data, error } = await supabase
  .from('requests')
  .insert({
    is_guest_request: true,
    contact_phone: '966501234567',
    contact_phone_verified: true,
    // ...
  });
```

### 3. ุงุฎุชุจุงุฑ ุงููุดุงูุฏุงุช (ุฒุงุฆุฑ)
```typescript
// ูุฌุจ ุฃู ูุนูู (ุงูุฏุงูุฉ ุชุณุชุฎุฏู SECURITY DEFINER)
const { data, error } = await supabase.rpc('increment_request_views', {
  request_id_param: requestId,
  session_id_param: sessionId,
  user_agent_param: userAgent,
});
```

---

## ๐ ููุฎุต ุงูุชุฃุซูุฑ

| ุงููููู | ูุจู | ุจุนุฏ | ุงูุชุฃุซูุฑ |
|--------|-----|-----|---------|
| **Function Search Path** | โ ูุนุฑุถ ููุฎุทุฑ | โ ุขูู | โ ูุง ุชุฃุซูุฑ ุนูู ุงููุธููุฉ |
| **requests (INSERT)** | โ ููุชูุญ ููุฌููุน | โ ูุชุญูู ูู author_id | โ ูุนูู ุจุดูู ุตุญูุญ |
| **reviews (INSERT/UPDATE/DELETE)** | โ ููุชูุญ ููุฌููุน | โ ูุชุญูู ูู author_id | โ๏ธ ูุญุชุงุฌ ูุญุต |
| **request_view_logs** | โ ููุชูุญ ููุฌููุน | โ ูุชุญูู ูู auth | โ ูุนูู (SECURITY DEFINER) |
| **verified_guests** | โ ุจุฏูู ูููุฏ | โ ูููุฏ ุนูู ุงูุจูุงูุงุช | โ ุขูู |
| **pending_categories** | โ ููุชูุญ ููุฌููุน | โ service_role ููุท | โ๏ธ ูุญุชุงุฌ ูุญุต |

---

## โ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### ูู ุงูุฅุตูุงุญุงุช ุชุฎุฑุจ ุงูุนููุ
**ูุง** - ุงูุฅุตูุงุญุงุช ุชุตูุญ ุซุบุฑุงุช ุฃูููุฉ ููุง ุชุบูุฑ ุงููุธููุฉ ุงูุฃุณุงุณูุฉ.

### ูู ููุงู ุชุฃุซูุฑ ููููุณุ
**ูุนู** - ูููู **ุฅูุฌุงุจู**:
1. โ **ุฃูุซุฑ ุฃูุงูุงู** - ููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู
2. โ **ูุง ูุดุงูู** - ุงูููุฏ ุงูููุฌูุฏ ูุนูู ุจุดูู ุตุญูุญ
3. โ๏ธ **ูุญุชุงุฌ ูุญุต** - ุจุนุถ ุงูุฃูุงูู ูุฏ ุชุญุชุงุฌ ุชุนุฏููุงุช ุจุณูุทุฉ

### ุงูุชูุตูุฉ:
1. โ **ุงุฎุชุจุฑ ุงูุชุทุจูู** - ุชุฃูุฏ ูู ุฃู ุฌููุน ุงููุธุงุฆู ุชุนูู
2. โ **ุฑุงูุจ ุงูุฃุฎุทุงุก** - ุฅุฐุง ุธูุฑุช ุฃุฎุทุงุก RLSุ ุฑุงุฌุน ุงูููุฏ
3. โ **ุงุณุชุฎุฏู service_role** - ูู Edge Functions ุนูุฏ ุงูุญุงุฌุฉ

---

## ๐ง ุฅุฐุง ูุงุฌูุช ูุดุงูู

### ูุดููุฉ: ูุดู ุฅูุดุงุก ุทูุจ
**ุงูุญู:** ุชุฃูุฏ ูู ุฃู `author_id = auth.uid()`

### ูุดููุฉ: ูุดู ุชุณุฌูู ุงููุดุงูุฏุงุช
**ุงูุญู:** ุงุณุชุฎุฏู ุงูุฏุงูุฉ `increment_request_views` ุจุฏูุงู ูู ุงูุฅุฏุฑุงุฌ ุงููุจุงุดุฑ

### ูุดููุฉ: ูุดู ุชุนุฏูู pending_categories
**ุงูุญู:** ุงุณุชุฎุฏู `service_role` ูู Edge Functions

---

## ๐ ุงููุฑุงุฌุน

- [RLS Policies Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Function Security](https://supabase.com/docs/guides/database/functions#security)
- ููู ุงูุฅุตูุงุญุงุช: `supabase/migrations/fix_security_warnings.sql`

